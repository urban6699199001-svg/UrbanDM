<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urban OSâ„¢ DM Designer v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    .gold { color: #C5A059; }
    .bg-gold { background-color: #C5A059; }
    .border-gold { border-color: #C5A059; }
    .navy { color: #1A365D; }
    .bg-navy { background-color: #1A365D; }
    @media print {
      .no-print { display: none !important; }
      .print-area { 
        width: 210mm !important; 
        height: 297mm !important; 
        margin: 0 !important;
        box-shadow: none !important;
        border: 16px double #C5A059 !important;
      }
      body { background: white !important; }
    }
    .spinner { border: 3px solid rgba(26,54,93,0.3); border-top-color: #C5A059; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen bg-slate-100">

<div id="app" class="flex flex-col lg:flex-row min-h-screen">
  <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
  <div id="control-panel" class="no-print w-full lg:w-[400px] bg-white p-6 overflow-y-auto shadow-xl">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-black navy">URBAN <span class="gold">OSâ„¢</span></h1>
      <p class="text-xs text-gray-400 tracking-widest">DM DESIGNER v2.0</p>
    </div>
    <div id="controls"></div>
  </div>
  
  <!-- å³å´é è¦½å€ -->
  <div class="flex-1 bg-slate-200 p-4 lg:p-8 overflow-auto flex justify-center items-start">
    <div id="preview" class="origin-top scale-[0.35] sm:scale-[0.45] lg:scale-[0.6] xl:scale-[0.75]"></div>
  </div>
</div>

<script>
// Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyBgBHsM92s9DH23uXDeo3EWQ5NjAM5nW0U",
  authDomain: "urban-os-v1.firebaseapp.com",
  databaseURL: "https://urban-os-v1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urban-os-v1",
  storageBucket: "urban-os-v1.firebasestorage.app",
  messagingSenderId: "594831737040",
  appId: "1:594831737040:web:f16c007399bf16843f1ed5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ç‹€æ…‹
const state = {
  loading: true,
  products: {},
  selectedProduct: null,
  selectedPlan: null,
  productData: null,
  
  // è¡¨å–®è³‡æ–™
  age: 35,
  gender: 'male',
  queryAge: 65,
  baseCoverage: 100,
  multiplier2: 2.5,
  multiplier3: 5.0,
  planName1: 'ç©©å¥æ–¹æ¡ˆ',
  planName2: 'é€²éšæ–¹æ¡ˆ',
  planName3: 'å°Šæ¦®æ–¹æ¡ˆ',
  exchangeRate: 32.5,
  displayCurrency: 'USD',
};

// æ™šæœŸé–‹å§‹é ˜å–å•†å“ï¼ˆä¸é¡¯ç¤º 1~yå¹´ç¸½é ˜ï¼‰
const LATE_START_PRODUCTS = ['PFW', 'PAL', 'PFV', 'PF55', 'PF60', 'PF65'];

// åˆå§‹åŒ–
async function init() {
  // å¾ URL è®€å–åƒæ•¸
  const params = new URLSearchParams(window.location.search);
  if (params.get('product')) state.selectedProduct = params.get('product');
  if (params.get('plan')) state.selectedPlan = params.get('plan');
  if (params.get('age')) state.age = parseInt(params.get('age'));
  if (params.get('gender')) state.gender = params.get('gender');
  if (params.get('coverage')) state.baseCoverage = parseFloat(params.get('coverage'));
  if (params.get('queryAge')) state.queryAge = parseInt(params.get('queryAge'));
  
  // è¼‰å…¥å•†å“åˆ—è¡¨
  const snapshot = await db.ref('products').once('value');
  const data = snapshot.val() || {};
  
  for (const [code, product] of Object.entries(data)) {
    if (code.startsWith('P') && product.info) {
      state.products[code] = product;
    }
  }
  
  // å¦‚æœæœ‰é é¸å•†å“ï¼Œè¼‰å…¥è³‡æ–™
  if (state.selectedProduct && state.products[state.selectedProduct]) {
    state.productData = state.products[state.selectedProduct];
    if (!state.selectedPlan) {
      const plans = Object.keys(state.productData.plans || {});
      if (plans.length > 0) state.selectedPlan = plans[0];
    }
    state.displayCurrency = state.productData.info.currency;
  }
  
  state.loading = false;
  render();
}

// é¸æ“‡å•†å“
function selectProduct(code) {
  state.selectedProduct = code;
  state.productData = state.products[code];
  const plans = Object.keys(state.productData.plans || {});
  state.selectedPlan = plans.length > 0 ? plans[0] : null;
  state.displayCurrency = state.productData.info.currency;
  render();
}

// é¸æ“‡æ–¹æ¡ˆ
function selectPlan(code) {
  state.selectedPlan = code;
  render();
}

// æ›´æ–°è¡¨å–®
function updateForm(field, value) {
  if (['age', 'queryAge', 'baseCoverage', 'multiplier2', 'multiplier3', 'exchangeRate'].includes(field)) {
    state[field] = parseFloat(value) || 0;
  } else {
    state[field] = value;
  }
  render();
}

// åˆ—å°
function printDM() {
  window.print();
}

// è¨ˆç®— DM æ•¸æ“š
function calculateDM() {
  if (!state.productData || !state.selectedPlan) return null;
  
  const plan = state.productData.plans[state.selectedPlan];
  if (!plan) return null;
  
  const rates = state.productData.rates;
  const age = state.age;
  const queryAge = state.queryAge;
  const queryYear = queryAge - age;
  const payYears = plan.payYears;
  const maturityYear = payYears + 1;
  
  const genderCode = state.gender === 'male' ? '01' : '02';
  const ageStr = age.toString().padStart(2, '0');
  const baseKey = `${plan.prefix}${genderCode}${ageStr}`;
  const bonuKey = `${baseKey}1`; // é«˜åˆ†ç´…
  
  // å–å¾—è²»ç‡
  const gpRate = rates.gp?.[baseKey];
  const cvRates = rates.cv?.[baseKey] || [];
  const dieRates = rates.die?.[baseKey] || [];
  const bonuRates = rates.bonu?.[bonuKey] || rates.bonu?.[baseKey] || [];
  const bonuCvRates = rates.bonu_cv?.[bonuKey] || rates.bonu_cv?.[baseKey] || [];
  const bonuDieRates = rates.bonu_die?.[bonuKey] || rates.bonu_die?.[baseKey] || [];
  const srvRates = rates.srv?.[baseKey] || [];
  
  if (typeof gpRate !== 'number') {
    console.error('æ‰¾ä¸åˆ°è²»ç‡', baseKey);
    return null;
  }
  
  // åˆ¤æ–·å•†å“é¡å‹
  const hasSrv = srvRates.length > 0 && srvRates.some(v => v > 0);
  const isLateStart = LATE_START_PRODUCTS.some(p => state.selectedProduct.startsWith(p));
  
  // æ‰¾å‡ºç”Ÿå­˜é‡‘é–‹å§‹å¹´åº¦
  let survivalStartYear = -1;
  if (hasSrv) {
    for (let i = 0; i < srvRates.length; i++) {
      if (srvRates[i] > 0 || (bonuRates[i] || 0) > 0) {
        survivalStartYear = i + 1;
        break;
      }
    }
  }
  const survivalStartAge = survivalStartYear > 0 ? age + survivalStartYear - 1 : -1;
  
  // è¨ˆç®—ä¸‰å€‹æ–¹æ¡ˆ
  const multipliers = [1, state.multiplier2, state.multiplier3];
  const plans = multipliers.map(mult => {
    const coverage = state.baseCoverage * mult;
    
    // å¹´ç¹³ä¿è²»
    const annualPremium = Math.ceil(gpRate * coverage);
    const totalDeposit = annualPremium * payYears;
    
    // ç¹³è²»æœŸé–“ç¸½é ˜ (1~ç¹³è²»å¹´æœŸ)
    let payPeriodBenefit = 0;
    if (hasSrv && !isLateStart) {
      for (let i = 0; i < payYears && i < srvRates.length; i++) {
        payPeriodBenefit += Math.ceil((srvRates[i] || 0) * coverage) + Math.ceil((bonuRates[i] || 0) * coverage);
      }
    }
    
    // æ»¿æœŸæ¯å¹´é ˜
    const benefitYear = survivalStartYear > 0 ? Math.max(survivalStartYear, maturityYear) : maturityYear;
    const annualBenefit = hasSrv && benefitYear <= srvRates.length
      ? Math.ceil((srvRates[benefitYear - 1] || 0) * coverage) + Math.ceil((bonuRates[benefitYear - 1] || 0) * coverage)
      : 0;
    
    // ç´¯ç©ç¸½é ˜ (1~æŸ¥è©¢å¹´åº¦)
    let cumulativeBenefit = 0;
    if (hasSrv) {
      for (let i = 0; i < queryYear && i < srvRates.length; i++) {
        cumulativeBenefit += Math.ceil((srvRates[i] || 0) * coverage) + Math.ceil((bonuRates[i] || 0) * coverage);
      }
    }
    
    // è§£ç´„é‡‘
    const surrenderValue = queryYear > 0 && queryYear <= cvRates.length
      ? Math.ceil((cvRates[queryYear - 1] || 0) * coverage) + Math.ceil((bonuCvRates[queryYear - 1] || 0) * coverage)
      : 0;
    
    // èº«æ•…ä¿éšªé‡‘
    const deathBenefit = queryYear > 0 && queryYear <= dieRates.length
      ? Math.ceil((dieRates[queryYear - 1] || 0) * coverage) + Math.ceil((bonuDieRates[queryYear - 1] || 0) * coverage)
      : 0;
    
    // ç¸½è³‡ç”¢
    const totalAsset = surrenderValue + cumulativeBenefit;
    
    return { coverage, annualPremium, totalDeposit, payPeriodBenefit, annualBenefit, cumulativeBenefit, surrenderValue, deathBenefit, totalAsset };
  });
  
  return {
    plans,
    hasSrv,
    isLateStart,
    survivalStartAge,
    payYears,
    currency: state.productData.info.currency
  };
}

// æ ¼å¼åŒ–é‡‘é¡
function formatMoney(value, showUnit = true) {
  if (!value || isNaN(value)) return 'â€”';
  
  const currency = state.productData?.info?.currency || 'TWD';
  let finalVal = value;
  
  // å¹£åˆ¥è½‰æ›
  if (currency === 'USD' && state.displayCurrency === 'TWD') {
    finalVal = value * state.exchangeRate;
  }
  
  const displayVal = (finalVal / 10000).toLocaleString('zh-TW', { maximumFractionDigits: 1 });
  const unit = state.displayCurrency === 'TWD' ? 'è¬å°å¹£' : 'è¬ç¾é‡‘';
  
  return showUnit ? `${displayVal} <span class="text-xs opacity-70">${unit}</span>` : displayVal;
}

// æ¸²æŸ“æ§åˆ¶é¢æ¿
function renderControls() {
  if (state.loading) {
    return '<div class="flex justify-center py-12"><div class="spinner"></div></div>';
  }
  
  let html = '';
  
  // å•†å“é¸æ“‡
  html += '<div class="mb-6 p-4 bg-navy rounded-2xl">';
  html += '<h3 class="text-sm font-bold text-amber-300 mb-3">å•†å“é¸æ“‡</h3>';
  html += '<select onchange="selectProduct(this.value)" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white text-sm">';
  html += '<option value="">è«‹é¸æ“‡å•†å“</option>';
  
  const sortedProducts = Object.entries(state.products).sort((a, b) => a[0].localeCompare(b[0]));
  for (const [code, prod] of sortedProducts) {
    const selected = state.selectedProduct === code ? 'selected' : '';
    const currency = prod.info.currency === 'USD' ? 'ğŸ’µ' : 'ğŸ’´';
    html += `<option value="${code}" ${selected}>${currency} ${code} - ${prod.info.name}</option>`;
  }
  html += '</select>';
  
  // æ–¹æ¡ˆé¸æ“‡
  if (state.productData) {
    html += '<div class="mt-3 flex flex-wrap gap-2">';
    for (const [code, plan] of Object.entries(state.productData.plans)) {
      const active = state.selectedPlan === code ? 'bg-amber-500 text-white' : 'bg-white/10 text-white/70';
      html += `<button onclick="selectPlan('${code}')" class="px-3 py-1 rounded-lg text-sm ${active}">${plan.displayName}</button>`;
    }
    html += '</div>';
    
    // é¡¯ç¤ºå¹£åˆ¥æ¨™ç±¤
    const currencyLabel = state.productData.info.currency === 'USD' ? 'ğŸ‡ºğŸ‡¸ ç¾é‡‘å•†å“' : 'ğŸ‡¹ğŸ‡¼ å°å¹£å•†å“';
    html += `<div class="mt-2"><span class="text-xs text-amber-200">${currencyLabel}</span></div>`;
  }
  html += '</div>';
  
  // å®¢æˆ¶è³‡æ–™
  html += '<div class="mb-6">';
  html += '<h3 class="text-sm font-bold gold mb-3">â€¢ å®¢æˆ¶è³‡æ–™</h3>';
  html += '<div class="grid grid-cols-2 gap-3">';
  html += `<div><label class="text-xs text-gray-500">æŠ•ä¿å¹´é½¡</label><input type="number" value="${state.age}" onchange="updateForm('age',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += `<div><label class="text-xs text-gray-500">æ€§åˆ¥</label><select onchange="updateForm('gender',this.value)" class="w-full p-2 border rounded-lg text-sm"><option value="male" ${state.gender==='male'?'selected':''}>ç”·æ€§</option><option value="female" ${state.gender==='female'?'selected':''}>å¥³æ€§</option></select></div>`;
  html += `<div><label class="text-xs text-gray-500">æŸ¥è©¢å¹´é½¡</label><input type="number" value="${state.queryAge}" onchange="updateForm('queryAge',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += `<div><label class="text-xs text-gray-500">åŸºæº–ä¿é¡(è¬)</label><input type="number" value="${state.baseCoverage}" onchange="updateForm('baseCoverage',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += '</div></div>';
  
  // é¡¯ç¤ºè¨­å®š
  if (state.productData?.info?.currency === 'USD') {
    html += '<div class="mb-6">';
    html += '<h3 class="text-sm font-bold gold mb-3">â€¢ é¡¯ç¤ºè¨­å®š</h3>';
    html += '<div class="grid grid-cols-2 gap-3">';
    html += `<div><label class="text-xs text-gray-500">åŒ¯ç‡</label><input type="number" step="0.1" value="${state.exchangeRate}" onchange="updateForm('exchangeRate',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
    html += `<div><label class="text-xs text-gray-500">é¡¯ç¤ºå¹£åˆ¥</label><select onchange="updateForm('displayCurrency',this.value)" class="w-full p-2 border rounded-lg text-sm"><option value="USD" ${state.displayCurrency==='USD'?'selected':''}>ç¾é‡‘</option><option value="TWD" ${state.displayCurrency==='TWD'?'selected':''}>å°å¹£</option></select></div>`;
    html += '</div></div>';
  }
  
  // æ–¹æ¡ˆè¨­å®š
  html += '<div class="mb-6">';
  html += '<h3 class="text-sm font-bold gold mb-3">â€¢ æ–¹æ¡ˆè¨­å®š</h3>';
  html += '<div class="space-y-2">';
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ1</span><input type="text" value="${state.planName1}" onchange="updateForm('planName1',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><span class="text-xs text-gray-400">x1</span></div>`;
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ2</span><input type="text" value="${state.planName2}" onchange="updateForm('planName2',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><input type="number" step="0.1" value="${state.multiplier2}" onchange="updateForm('multiplier2',this.value)" class="w-16 p-2 border rounded-lg text-sm text-center"/></div>`;
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ3</span><input type="text" value="${state.planName3}" onchange="updateForm('planName3',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><input type="number" step="0.1" value="${state.multiplier3}" onchange="updateForm('multiplier3',this.value)" class="w-16 p-2 border rounded-lg text-sm text-center"/></div>`;
  html += '</div></div>';
  
  // åˆ—å°æŒ‰éˆ•
  html += '<button onclick="printDM()" class="w-full py-3 bg-navy text-white rounded-xl font-bold hover:bg-blue-900">ğŸ–¨ï¸ åˆ—å° / è¼¸å‡º PDF</button>';
  
  // è¿”å›è©¦ç®—ç³»çµ±
  html += '<a href="insurance-calculator-v7.html" class="block mt-3 text-center text-sm text-blue-500 hover:underline">â† è¿”å›è©¦ç®—ç³»çµ±</a>';
  
  return html;
}

// æ¸²æŸ“ DM é è¦½
function renderPreview() {
  const result = calculateDM();
  
  if (!result) {
    return `
      <div class="print-area bg-white shadow-2xl flex items-center justify-center" style="width:210mm;height:297mm;border:16px double #C5A059;">
        <div class="text-center">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-xl font-bold navy">è«‹é¸æ“‡å•†å“</p>
          <p class="text-gray-400 text-sm mt-2">Select a product to generate DM</p>
        </div>
      </div>
    `;
  }
  
  const { plans, hasSrv, isLateStart, survivalStartAge, payYears, currency } = result;
  const genderText = state.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
  const currencyIcon = currency === 'USD' ? 'ç¾å…ƒ' : 'å°å¹£';
  
  // ç”Ÿæˆè¡¨æ ¼è¡Œ
  let tableRows = '';
  
  // 1. æ¯å¹´å­˜å…¥
  tableRows += `<tr class="border-b border-amber-200/30">
    <td class="py-4 px-3 text-center font-bold navy">æ¯å¹´å­˜å…¥</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.annualPremium)}</td>`).join('')}
  </tr>`;
  
  // 2. ç´¯ç©ç¸½æŠ•å…¥
  tableRows += `<tr class="border-b border-amber-200/30">
    <td class="py-4 px-3 text-center font-bold navy">ç´¯ç©ç¸½æŠ•å…¥</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.totalDeposit)}</td>`).join('')}
  </tr>`;
  
  if (isLateStart && hasSrv) {
    // PFW/PAL/PFV/PF55/PF60/PF65 é¡å•†å“
    // å¾xxæ­²èµ·æ¯å¹´é ˜
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">å¾${survivalStartAge}æ­²èµ·æ¯å¹´é ˜</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.annualBenefit)}</td>`).join('')}
    </tr>`;
    
    // ~næ­²ç¸½é ˜
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">~${state.queryAge}æ­²ç¸½é ˜</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.cumulativeBenefit)}</td>`).join('')}
    </tr>`;
    
    // næ­²å¸³æˆ¶åƒ¹å€¼
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²å¸³æˆ¶åƒ¹å€¼</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
  } else if (hasSrv) {
    // PAC/PFE ç­‰æ—©æœŸé–‹å§‹é ˜å–å•†å“
    // 1~yå¹´ç¸½é ˜ï¼ˆæœ‰å€¼æ‰é¡¯ç¤ºï¼‰
    if (plans.some(p => p.payPeriodBenefit > 0)) {
      tableRows += `<tr class="border-b border-amber-200/30">
        <td class="py-4 px-3 text-center font-bold navy">1~${payYears}å¹´ç¸½é ˜</td>
        ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.payPeriodBenefit)}</td>`).join('')}
      </tr>`;
    }
    
    // æ»¿æœŸæ¯å¹´é ˜
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">æ»¿æœŸæ¯å¹´é ˜</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.annualBenefit)}</td>`).join('')}
    </tr>`;
    
    // 1~Nå¹´ç´¯ç©ç¸½é ˜
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">1~${state.queryAge - state.age}å¹´ç´¯ç©ç¸½é ˜</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.cumulativeBenefit)}</td>`).join('')}
    </tr>`;
    
    // næ­²è§£ç´„é‡‘
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è§£ç´„é‡‘</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
    // næ­²è³‡ç”¢ç¸½å€¼
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è³‡ç”¢ç¸½å€¼</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.totalAsset)}</td>`).join('')}
    </tr>`;
    
  } else {
    // ç´”å¢å€¼å‹å•†å“
    // ç¬¬Yå¹´å¸³æˆ¶åƒ¹å€¼
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">ç¬¬${payYears+1}å¹´å¸³æˆ¶åƒ¹å€¼</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
    // næ­²è§£ç´„é‡‘
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è§£ç´„é‡‘</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
  }
  
  // èº«æ•…å°Šæ¦®å‚³æ‰¿
  tableRows += `<tr>
    <td class="py-4 px-3 text-center font-bold italic text-amber-800">èº«æ•…å°Šæ¦®å‚³æ‰¿</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.deathBenefit)}</td>`).join('')}
  </tr>`;
  
  return `
    <div class="print-area bg-white shadow-2xl flex flex-col" style="width:210mm;height:297mm;border:16px double #C5A059;">
      <!-- Header 16% -->
      <div class="h-[16%] flex flex-col items-center justify-center text-center px-8 border-b-2 border-amber-300/50 bg-amber-50/50">
        <p class="gold font-bold tracking-[0.5em] text-sm mb-1">ELITE WEALTH MANAGEMENT</p>
        <h1 class="text-6xl font-black navy leading-tight">
          æ‚¨çš„é€€ä¼‘é‡‘<br/>
          <span class="inline-block w-20"></span><span class="gold italic">é‚„åœ¨ç¡è¦ºå—ï¼Ÿ</span>
        </h1>
        <div class="h-1 w-64 bg-gradient-to-r from-transparent via-amber-400 to-transparent mt-2"></div>
      </div>
      
      <!-- Icons 12% -->
      <div class="h-[12%] flex items-center justify-center gap-16 border-b border-amber-200/30 py-4">
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">$</span>
          </div>
          <p class="font-black navy text-lg">${currencyIcon}è³‡ç”¢</p>
          <p class="text-xs gold tracking-widest">GLOBAL ASSET</p>
        </div>
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">â†—</span>
          </div>
          <p class="font-black navy text-lg">ç©©å¥å¢å€¼</p>
          <p class="text-xs gold tracking-widest">BONUS VALUE</p>
        </div>
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">ğŸ“…</span>
          </div>
          <p class="font-black navy text-lg">é€€ä¼‘è‡ªç”±</p>
          <p class="text-xs gold tracking-widest">RETIRE FREE</p>
        </div>
      </div>
      
      <!-- Table 62% -->
      <div class="h-[62%] px-6 py-4 flex flex-col">
        <div class="flex justify-between items-center mb-3">
          <div>
            <h2 class="text-4xl font-black navy"><span class="gold italic font-serif">The</span> Private Plan</h2>
            <p class="text-sm text-gray-500">${state.productData?.info?.fullName || ''}</p>
          </div>
          <div class="text-right">
            <div class="bg-navy text-amber-300 px-6 py-2 rounded-full font-bold">${state.age}æ­² ${genderText} è²´è³“å°ˆå±¬</div>
            <p class="text-sm gold mt-1">æŸ¥è©¢å¹´é½¡: ${state.queryAge}æ­² ï½œ ${payYears}å¹´æœŸ</p>
          </div>
        </div>
        
        <div class="flex-1 border-2 border-amber-300/50 rounded-3xl overflow-hidden">
          <table class="w-full h-full">
            <thead>
              <tr class="bg-navy text-white">
                <th class="py-4 px-3 text-center font-bold w-[24%]">åˆ†æé …ç›®</th>
                <th class="py-4 text-center font-bold">${state.planName1}</th>
                <th class="py-4 text-center font-bold">${state.planName2}</th>
                <th class="py-4 text-center font-bold bg-blue-900">${state.planName3}</th>
              </tr>
            </thead>
            <tbody class="text-lg">
              ${tableRows}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Footer 10% -->
      <div class="h-[10%] flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 flex items-center justify-center opacity-5">
          <span class="text-[180px] font-black gold">URBAN</span>
        </div>
        <div class="relative text-center">
          <h3 class="text-4xl font-black gold italic tracking-widest">ç¾åœ¨æ±ºå®šãƒ»æœªä¾†æ›´è¼•é¬†</h3>
          <p class="text-xs text-gray-400 tracking-[0.3em] mt-1">PROFESSIONAL HERITAGE PLANNING ãƒ» URBAN OSâ„¢ DM DESIGNER</p>
        </div>
      </div>
    </div>
  `;
}

// ä¸»æ¸²æŸ“å‡½æ•¸
function render() {
  document.getElementById('controls').innerHTML = renderControls();
  document.getElementById('preview').innerHTML = renderPreview();
}

// å•Ÿå‹•
init();
</script>
</body>
</html>
