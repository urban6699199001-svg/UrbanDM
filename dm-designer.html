<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urban OSâ„¢ DM Designer v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    .gold { color: #C5A059; }
    .bg-gold { background-color: #C5A059; }
    .border-gold { border-color: #C5A059; }
    .navy { color: #1A365D; }
    .bg-navy { background-color: #1A365D; }
    @media print {
      .no-print { display: none !important; }
      .print-area { 
        width: 210mm !important; 
        height: 297mm !important; 
        margin: 0 !important;
        box-shadow: none !important;
        border: 16px double #C5A059 !important;
      }
      body { background: white !important; }
    }
    .spinner { border: 3px solid rgba(26,54,93,0.3); border-top-color: #C5A059; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen bg-slate-100">

<div id="app" class="flex flex-col lg:flex-row min-h-screen">
  <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
  <div id="control-panel" class="no-print w-full lg:w-[400px] bg-white p-6 overflow-y-auto shadow-xl">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-black navy">URBAN <span class="gold">OSâ„¢</span></h1>
      <p class="text-xs text-gray-400 tracking-widest">DM DESIGNER v2.0</p>
    </div>
    <div id="controls"></div>
  </div>
  
  <!-- å³å´é è¦½å€ -->
  <div class="flex-1 bg-slate-200 p-4 lg:p-8 overflow-auto flex justify-center items-start">
    <div id="preview" class="origin-top scale-[0.35] sm:scale-[0.45] lg:scale-[0.6] xl:scale-[0.75]"></div>
  </div>
</div>

<script>
// Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyBgBHsM92s9DH23uXDeo3EWQ5NjAM5nW0U",
  authDomain: "urban-os-v1.firebaseapp.com",
  databaseURL: "https://urban-os-v1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urban-os-v1",
  storageBucket: "urban-os-v1.firebasestorage.app",
  messagingSenderId: "594831737040",
  appId: "1:594831737040:web:f16c007399bf16843f1ed5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ç‹€æ…‹
const state = {
  loading: true,
  products: {},
  selectedProduct: null,
  selectedPlan: null,
  productData: null,
  
  // è¡¨å–®è³‡æ–™
  age: 35,
  gender: 'male',
  queryAge: 65,
  baseCoverage: 100,
  multiplier2: 2.5,
  multiplier3: 5.0,
  planName1: 'ç©©å¥æ–¹æ¡ˆ',
  planName2: 'é€²éšæ–¹æ¡ˆ',
  planName3: 'å°Šæ¦®æ–¹æ¡ˆ',
  exchangeRate: 32.5,
  displayCurrency: 'USD',
  
  // ç´…åˆ©è¨­å®š
  dividendMethod: 'ç¹³æ¸…ä¿éšªé‡‘é¡',  // ç¹³æ¸…ä¿éšªé‡‘é¡ / å„²å­˜ç”Ÿæ¯ / ç¾é‡‘çµ¦ä»˜
  dividendLevel: 'high',           // high / medium / low / zero
};

// æ™šæœŸé–‹å§‹é ˜å–å•†å“ï¼ˆä¸é¡¯ç¤º 1~yå¹´ç¸½é ˜ï¼‰
const LATE_START_PRODUCTS = ['PFW', 'PAL', 'PFV', 'PF55', 'PF60', 'PF65'];

// åˆå§‹åŒ–
async function init() {
  // å¾ URL è®€å–åƒæ•¸
  const params = new URLSearchParams(window.location.search);
  if (params.get('product')) state.selectedProduct = params.get('product');
  if (params.get('plan')) state.selectedPlan = params.get('plan');
  if (params.get('age')) state.age = parseInt(params.get('age'));
  if (params.get('gender')) state.gender = params.get('gender');
  if (params.get('coverage')) state.baseCoverage = parseFloat(params.get('coverage'));
  if (params.get('queryAge')) state.queryAge = parseInt(params.get('queryAge'));
  if (params.get('dividendMethod')) state.dividendMethod = params.get('dividendMethod');
  if (params.get('dividendLevel')) state.dividendLevel = params.get('dividendLevel');
  
  // è¼‰å…¥å•†å“åˆ—è¡¨ï¼ˆåªè¼‰å…¥ info å’Œ plansï¼Œä¸è¼‰å…¥ ratesï¼‰
  const snapshot = await db.ref('products').once('value');
  const data = snapshot.val() || {};
  
  for (const [code, product] of Object.entries(data)) {
    if (code.startsWith('P') && product.info) {
      // åªå­˜ info å’Œ plansï¼Œä¸å­˜ ratesï¼ˆå¤ªå¤§ï¼‰
      state.products[code] = {
        info: product.info,
        plans: product.plans
      };
    }
  }
  
  // å¦‚æœæœ‰é é¸å•†å“ï¼Œè¼‰å…¥å®Œæ•´è³‡æ–™ï¼ˆåŒ…å« ratesï¼‰
  if (state.selectedProduct && state.products[state.selectedProduct]) {
    await loadProductRates(state.selectedProduct);
    if (!state.selectedPlan) {
      const plans = Object.keys(state.productData.plans || {});
      if (plans.length > 0) state.selectedPlan = plans[0];
    }
  }
  
  state.loading = false;
  render();
}

// è¼‰å…¥å–®ä¸€å•†å“çš„ rates
async function loadProductRates(code) {
  const ratesSnap = await db.ref('products/' + code + '/rates').once('value');
  const rates = ratesSnap.val();
  
  state.productData = {
    ...state.products[code],
    rates: rates
  };
  state.displayCurrency = state.productData.info.currency;
}

// é¸æ“‡å•†å“
async function selectProduct(code) {
  state.selectedProduct = code;
  state.loading = true;
  render();
  
  await loadProductRates(code);
  
  const plans = Object.keys(state.productData.plans || {});
  state.selectedPlan = plans.length > 0 ? plans[0] : null;
  
  // è¨­å®šé è¨­ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼ˆç¬¬ä¸€å€‹é¸é …ï¼‰
  const dividendOptions = state.productData.info?.dividendOptions || ['ç¹³æ¸…ä¿éšªé‡‘é¡'];
  state.dividendMethod = dividendOptions[0];
  
  // è¨­å®šé è¨­åˆ†ç´…å‡è¨­ï¼ˆé«˜åˆ†ç´…ï¼‰
  state.dividendLevel = 'high';
  
  state.loading = false;
  render();
}

// é¸æ“‡æ–¹æ¡ˆ
function selectPlan(code) {
  state.selectedPlan = code;
  render();
}

// æ›´æ–°è¡¨å–®
function updateForm(field, value) {
  if (['age', 'queryAge', 'baseCoverage', 'multiplier2', 'multiplier3', 'exchangeRate'].includes(field)) {
    state[field] = parseFloat(value) || 0;
  } else {
    state[field] = value;
  }
  render();
}

// åˆ—å°
function printDM() {
  window.print();
}

// è¨ˆç®— DM æ•¸æ“šï¼ˆä½¿ç”¨ v7.27 å®Œæ•´è¨ˆç®—é‚è¼¯ï¼‰
function calculateDM() {
  if (!state.productData || !state.selectedPlan) return null;
  
  const plan = state.productData.plans[state.selectedPlan];
  if (!plan) return null;
  
  const rates = state.productData.rates;
  const age = state.age;
  const queryAge = state.queryAge;
  const queryYear = queryAge - age + 1;
  const payYears = plan.payYears;
  const maturityYear = payYears + 1;
  
  const genderCode = state.gender === 'male' ? '01' : '02';
  const ageStr = age.toString().padStart(2, '0');
  const baseKey = `${plan.prefix}${genderCode}${ageStr}`;
  
  // ç´…åˆ© keyï¼šé«˜/ä¸­åˆ†ç´…ç”¨ 2ï¼Œä½åˆ†ç´…ç”¨ 1
  const bonuSuffix = (state.dividendLevel === 'low' || state.dividendLevel === 'zero') ? '1' : '2';
  const bonuKey = `${baseKey}${bonuSuffix}`;
  const isZeroDividend = state.dividendLevel === 'zero';
  
  // ç´…åˆ©çµ¦ä»˜æ–¹å¼
  const isCashDividend = state.dividendMethod === 'ç¾é‡‘çµ¦ä»˜';
  const isStoredInterest = state.dividendMethod === 'å„²å­˜ç”Ÿæ¯';
  const isPaidUp = !isCashDividend && !isStoredInterest;  // ç¹³æ¸…ä¿éšªé‡‘é¡
  
  // å„²å­˜ç”Ÿæ¯åˆ©ç‡
  const storedInterestRate = state.productData.info?.storedInterestRate || 0.0265;
  const monthlyRate = storedInterestRate / 12;
  const annualFactor = Math.pow(1 + monthlyRate, 12);
  
  // å–å¾—è²»ç‡
  const gpRate = rates.gp?.[baseKey];
  const cvRates = rates.cv?.[baseKey] || [];
  const dieRates = rates.die?.[baseKey] || [];
  const die2Rates = rates.die2?.[baseKey] || [];
  const bonuRates = isZeroDividend ? [] : (rates.bonu?.[bonuKey] || rates.bonu?.[baseKey] || []);
  const bonuCvRates = isZeroDividend ? [] : (rates.bonu_cv?.[bonuKey] || rates.bonu_cv?.[baseKey] || []);
  const bonuDieRates = isZeroDividend ? [] : (rates.bonu_die?.[bonuKey] || rates.bonu_die?.[baseKey] || []);
  const srvRates = rates.srv?.[baseKey] || [];
  const pvfbRates = rates.pvfb?.[baseKey] || [];
  const pvfb0Rates = rates.pvfb0?.[baseKey] || [];
  
  if (typeof gpRate !== 'number') {
    console.error('æ‰¾ä¸åˆ°è²»ç‡', baseKey);
    return null;
  }
  
  // åˆ¤æ–·å•†å“é¡å‹
  const hasSrv = srvRates.length > 0 && srvRates.some(v => v > 0);
  const isLateStart = LATE_START_PRODUCTS.some(p => state.selectedProduct.startsWith(p));
  
  // æ‰¾å‡ºç”Ÿå­˜é‡‘é–‹å§‹å¹´åº¦å’Œå¹´é½¡
  let survivalStartYear = -1;
  let survivalStartAge = -1;
  if (hasSrv) {
    for (let i = 0; i < srvRates.length; i++) {
      if (srvRates[i] > 0) {
        survivalStartYear = i + 1;
        survivalStartAge = age + survivalStartYear - 1;
        break;
      }
    }
  }
  
  // è¨ˆç®—ä¸‰å€‹æ–¹æ¡ˆ
  const multipliers = [1, state.multiplier2, state.multiplier3];
  const plans = multipliers.map(mult => {
    const coverage = state.baseCoverage * mult;
    
    // å¹´ç¹³ä¿è²»
    const annualPremium = Math.ceil(gpRate * coverage);
    const totalDeposit = annualPremium * payYears;
    
    // ========== ä½¿ç”¨ v7.27 å®Œæ•´è¨ˆç®—é‚è¼¯ ==========
    let cumSurvival = 0;
    let reducedCumPaidUp = 0;      // ç´¯è¨ˆç¹³æ¸…ä¿é¡ï¼ˆç¹³æ¸…ä¿éšªé‡‘é¡æ¨¡å¼ï¼‰
    let cumStoredDividend = 0;     // ç´¯è¨ˆå„²å­˜ç”Ÿæ¯ç´…åˆ©
    let annualBenefitAtMaturity = 0;
    let payPeriodBenefit = 0;
    
    // é€å¹´è¨ˆç®—åˆ°æŸ¥è©¢å¹´åº¦
    for (let year = 1; year <= Math.max(queryYear, maturityYear); year++) {
      const idx = year - 1;
      
      // æ­¥é©Ÿ1: ç•¶å¹´ç´…åˆ© K
      const bonuRate = bonuRates[idx] || 0;
      const kBase = bonuRate ? Math.round(bonuRate * coverage) : 0;
      const kAdded = (isPaidUp && reducedCumPaidUp && bonuRate) ? Math.round(reducedCumPaidUp * bonuRate / 10000) : 0;
      const annualDividendK = kBase + kAdded;
      
      // å„²å­˜ç”Ÿæ¯ç´¯ç©
      if (isStoredInterest) {
        if (year === 1) {
          cumStoredDividend = kBase;
        } else {
          cumStoredDividend = Math.round(cumStoredDividend * annualFactor + kBase);
        }
      }
      
      // æ­¥é©Ÿ2: è¨ˆç®—ç•¶å¹´ç¹³æ¸…ä¿é¡ Mï¼ˆåƒ…ç¹³æ¸…ä¿éšªé‡‘é¡æ¨¡å¼ï¼‰
      let paidUpThisYear = 0;
      if (isPaidUp) {
        const pvfbNext = pvfbRates[year] || 0;
        paidUpThisYear = (annualDividendK > 0 && pvfbNext > 0) ? Math.ceil(annualDividendK / pvfbNext * 10000) : 0;
      }
      
      // æ­¥é©Ÿ3: æ›´æ–°ç´¯è¨ˆç¹³æ¸…ä¿é¡
      if (isPaidUp) {
        reducedCumPaidUp = Math.ceil(reducedCumPaidUp + paidUpThisYear);
      }
      
      // æ­¥é©Ÿ4: è¨ˆç®—ç”Ÿå­˜é‡‘ï¼ˆæ ¹æ“šç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼‰
      const srvRate = srvRates[idx] || 0;
      const survivalF = srvRate ? Math.round(srvRate * coverage) : 0;
      const survivalO = (isPaidUp && srvRate && reducedCumPaidUp) ? Math.round(srvRate * reducedCumPaidUp / 10000) : 0;
      
      let survival;
      if (isCashDividend) {
        survival = survivalF + kBase;  // ç¾é‡‘çµ¦ä»˜ï¼šåŸºæœ¬ + ç•¶å¹´ç´…åˆ©
      } else if (isStoredInterest) {
        survival = survivalF;          // å„²å­˜ç”Ÿæ¯ï¼šåªæœ‰åŸºæœ¬
      } else {
        survival = survivalF + survivalO;  // ç¹³æ¸…ä¿éšªé‡‘é¡ï¼šåŸºæœ¬ + ç¹³æ¸…ä¿é¡çµ„ä»¶
      }
      
      cumSurvival += survival;
      
      // è¨˜éŒ„ç¹³è²»æœŸé–“ç¸½é ˜
      if (year <= payYears) {
        payPeriodBenefit += survival;
      }
      
      // è¨˜éŒ„æ»¿æœŸå¾Œç¬¬ä¸€å¹´çš„ç”Ÿå­˜é‡‘ï¼ˆæˆ–é–‹å§‹é ˜å–å¹´åº¦ï¼‰
      if (hasSrv && survivalStartYear > 0) {
        if (year === Math.max(survivalStartYear, maturityYear)) {
          annualBenefitAtMaturity = survival;
        }
      }
    }
    
    // æŸ¥è©¢å¹´åº¦çš„è§£ç´„é‡‘ï¼ˆæ ¹æ“šç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼‰
    const queryIdx = queryYear - 1;
    const cvRate = cvRates[queryIdx] || 0;
    const bonuCvRate = bonuCvRates[queryIdx] || 0;
    const pvfb0Rate = pvfb0Rates[queryYear] || 0;
    
    const surrenderB = cvRate ? Math.round(cvRate * coverage) : 0;
    const surrenderE = (isPaidUp && reducedCumPaidUp && pvfb0Rate) ? Math.round(reducedCumPaidUp * pvfb0Rate / 10000) : 0;
    const surrenderY = bonuCvRate ? Math.round(bonuCvRate * coverage) : 0;
    
    let surrenderValue;
    if (isCashDividend) {
      const lastKBase = (bonuRates[queryIdx] || 0) ? Math.round((bonuRates[queryIdx] || 0) * coverage) : 0;
      surrenderValue = surrenderB + lastKBase + surrenderY;
    } else if (isStoredInterest) {
      surrenderValue = surrenderB + cumStoredDividend + surrenderY;
    } else {
      surrenderValue = surrenderB + surrenderE + surrenderY;
    }
    
    // æŸ¥è©¢å¹´åº¦çš„èº«æ•…ä¿éšªé‡‘ï¼ˆæ ¹æ“šç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼‰
    const dieRate = dieRates[queryIdx] || 0;
    const die2Rate = die2Rates[queryIdx] || 0;
    const bonuDieRate = bonuDieRates[queryIdx] || 0;
    
    const deathA = dieRate ? Math.round(dieRate * coverage) : 0;
    const deathD = (isPaidUp && reducedCumPaidUp && die2Rate) ? Math.round(reducedCumPaidUp * die2Rate / 10000) : 0;
    const deathX = bonuDieRate ? Math.round(bonuDieRate * coverage) : 0;
    
    let deathBenefit;
    if (isCashDividend) {
      const lastKBase = (bonuRates[queryIdx] || 0) ? Math.round((bonuRates[queryIdx] || 0) * coverage) : 0;
      deathBenefit = deathA + lastKBase + deathX;
    } else if (isStoredInterest) {
      deathBenefit = deathA + cumStoredDividend + deathX;
    } else {
      deathBenefit = deathA + deathD + deathX;
    }
    
    // ç¸½è³‡ç”¢
    const totalAsset = surrenderValue + cumSurvival;
    
    return { 
      coverage, 
      annualPremium, 
      totalDeposit, 
      payPeriodBenefit,
      annualBenefit: annualBenefitAtMaturity, 
      cumulativeBenefit: cumSurvival, 
      surrenderValue, 
      deathBenefit, 
      totalAsset 
    };
  });
  
  return {
    plans,
    hasSrv,
    isLateStart,
    survivalStartYear,
    survivalStartAge,
    payYears,
    currency: state.productData.info.currency
  };
}

// æ ¼å¼åŒ–é‡‘é¡
function formatMoney(value, showUnit = true) {
  if (!value || isNaN(value)) return 'â€”';
  
  const currency = state.productData?.info?.currency || 'TWD';
  let finalVal = value;
  
  // å¹£åˆ¥è½‰æ›
  if (currency === 'USD' && state.displayCurrency === 'TWD') {
    finalVal = value * state.exchangeRate;
  }
  
  const displayVal = (finalVal / 10000).toLocaleString('zh-TW', { maximumFractionDigits: 1 });
  const unit = state.displayCurrency === 'TWD' ? 'è¬å°å¹£' : 'è¬ç¾é‡‘';
  
  return showUnit ? `${displayVal} <span class="text-xs opacity-70">${unit}</span>` : displayVal;
}

// æ¸²æŸ“æ§åˆ¶é¢æ¿
function renderControls() {
  if (state.loading) {
    return '<div class="flex justify-center py-12"><div class="spinner"></div></div>';
  }
  
  let html = '';
  
  // å•†å“é¸æ“‡
  html += '<div class="mb-6 p-4 bg-navy rounded-2xl">';
  html += '<h3 class="text-sm font-bold text-amber-300 mb-3">å•†å“é¸æ“‡</h3>';
  html += '<select onchange="selectProduct(this.value)" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white text-sm">';
  html += '<option value="">è«‹é¸æ“‡å•†å“</option>';
  
  const sortedProducts = Object.entries(state.products).sort((a, b) => a[0].localeCompare(b[0]));
  for (const [code, prod] of sortedProducts) {
    const selected = state.selectedProduct === code ? 'selected' : '';
    const currency = prod.info.currency === 'USD' ? 'ğŸ’µ' : 'ğŸ’´';
    html += `<option value="${code}" ${selected}>${currency} ${code} - ${prod.info.name}</option>`;
  }
  html += '</select>';
  
  // æ–¹æ¡ˆé¸æ“‡
  if (state.productData) {
    html += '<div class="mt-3 flex flex-wrap gap-2">';
    for (const [code, plan] of Object.entries(state.productData.plans)) {
      const active = state.selectedPlan === code ? 'bg-amber-500 text-white' : 'bg-white/10 text-white/70';
      html += `<button onclick="selectPlan('${code}')" class="px-3 py-1 rounded-lg text-sm ${active}">${plan.displayName}</button>`;
    }
    html += '</div>';
    
    // é¡¯ç¤ºå¹£åˆ¥æ¨™ç±¤
    const currencyLabel = state.productData.info.currency === 'USD' ? 'ğŸ‡ºğŸ‡¸ ç¾é‡‘å•†å“' : 'ğŸ‡¹ğŸ‡¼ å°å¹£å•†å“';
    html += `<div class="mt-2"><span class="text-xs text-amber-200">${currencyLabel}</span></div>`;
  }
  html += '</div>';
  
  // å®¢æˆ¶è³‡æ–™
  html += '<div class="mb-6">';
  html += '<h3 class="text-sm font-bold gold mb-3">â€¢ å®¢æˆ¶è³‡æ–™</h3>';
  html += '<div class="grid grid-cols-2 gap-3">';
  html += `<div><label class="text-xs text-gray-500">æŠ•ä¿å¹´é½¡</label><input type="number" value="${state.age}" onchange="updateForm('age',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += `<div><label class="text-xs text-gray-500">æ€§åˆ¥</label><select onchange="updateForm('gender',this.value)" class="w-full p-2 border rounded-lg text-sm"><option value="male" ${state.gender==='male'?'selected':''}>ç”·æ€§</option><option value="female" ${state.gender==='female'?'selected':''}>å¥³æ€§</option></select></div>`;
  html += `<div><label class="text-xs text-gray-500">æŸ¥è©¢å¹´é½¡</label><input type="number" value="${state.queryAge}" onchange="updateForm('queryAge',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += `<div><label class="text-xs text-gray-500">åŸºæº–ä¿é¡(è¬)</label><input type="number" value="${state.baseCoverage}" onchange="updateForm('baseCoverage',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
  html += '</div></div>';
  
  // ç´…åˆ©è¨­å®šï¼ˆæ ¹æ“šå•†å“æ”¯æ´çš„é¸é …å‹•æ…‹é¡¯ç¤ºï¼‰
  if (state.productData) {
    const dividendOptions = state.productData.info?.dividendOptions || ['ç¹³æ¸…ä¿éšªé‡‘é¡'];
    const levelOptions = state.productData.info?.dividendLevelOptions || ['é«˜åˆ†ç´…', 'ä¸­åˆ†ç´…', 'ä½åˆ†ç´…'];
    const levelMapping = {'é«˜åˆ†ç´…': 'high', 'ä¸­åˆ†ç´…': 'medium', 'ä½åˆ†ç´…': 'low', 'æœ€å¯èƒ½ç´…åˆ©': 'medium', 'è¼ƒä½ç´…åˆ©': 'low', 'å¯èƒ½ç´…åˆ©é‡‘é¡ç‚º0': 'zero'};
    
    html += '<div class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-200">';
    html += '<h3 class="text-sm font-bold text-purple-700 mb-3">â€¢ ç´…åˆ©è¨­å®š</h3>';
    html += '<div class="grid grid-cols-1 gap-3">';
    
    // ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼ˆå¦‚æœæœ‰å¤šå€‹é¸é …ï¼‰
    if (dividendOptions.length > 1) {
      html += '<div><label class="text-xs text-purple-600">ç´…åˆ©çµ¦ä»˜æ–¹å¼</label>';
      html += '<select onchange="updateForm(\'dividendMethod\',this.value)" class="w-full p-2 border border-purple-300 rounded-lg text-sm bg-white">';
      for (const opt of dividendOptions) {
        const selected = state.dividendMethod === opt ? 'selected' : '';
        html += `<option value="${opt}" ${selected}>${opt}</option>`;
      }
      html += '</select></div>';
    } else {
      html += `<div class="text-xs text-purple-600">ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼š${dividendOptions[0]}</div>`;
    }
    
    // åˆ†ç´…å‡è¨­
    html += '<div><label class="text-xs text-purple-600">åˆ†ç´…å‡è¨­</label>';
    html += '<select onchange="updateForm(\'dividendLevel\',this.value)" class="w-full p-2 border border-purple-300 rounded-lg text-sm bg-white">';
    for (const opt of levelOptions) {
      const val = levelMapping[opt] || 'medium';
      const selected = state.dividendLevel === val ? 'selected' : '';
      html += `<option value="${val}" ${selected}>${opt}</option>`;
    }
    html += '</select></div>';
    
    html += '</div></div>';
  }
  
  // é¡¯ç¤ºè¨­å®š
  if (state.productData?.info?.currency === 'USD') {
    html += '<div class="mb-6">';
    html += '<h3 class="text-sm font-bold gold mb-3">â€¢ é¡¯ç¤ºè¨­å®š</h3>';
    html += '<div class="grid grid-cols-2 gap-3">';
    html += `<div><label class="text-xs text-gray-500">åŒ¯ç‡</label><input type="number" step="0.1" value="${state.exchangeRate}" onchange="updateForm('exchangeRate',this.value)" class="w-full p-2 border rounded-lg text-sm"/></div>`;
    html += `<div><label class="text-xs text-gray-500">é¡¯ç¤ºå¹£åˆ¥</label><select onchange="updateForm('displayCurrency',this.value)" class="w-full p-2 border rounded-lg text-sm"><option value="USD" ${state.displayCurrency==='USD'?'selected':''}>ç¾é‡‘</option><option value="TWD" ${state.displayCurrency==='TWD'?'selected':''}>å°å¹£</option></select></div>`;
    html += '</div></div>';
  }
  
  // æ–¹æ¡ˆè¨­å®š
  html += '<div class="mb-6">';
  html += '<h3 class="text-sm font-bold gold mb-3">â€¢ æ–¹æ¡ˆè¨­å®š</h3>';
  html += '<div class="space-y-2">';
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ1</span><input type="text" value="${state.planName1}" onchange="updateForm('planName1',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><span class="text-xs text-gray-400">x1</span></div>`;
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ2</span><input type="text" value="${state.planName2}" onchange="updateForm('planName2',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><input type="number" step="0.1" value="${state.multiplier2}" onchange="updateForm('multiplier2',this.value)" class="w-16 p-2 border rounded-lg text-sm text-center"/></div>`;
  html += `<div class="flex items-center gap-2"><span class="w-16 text-xs text-gray-500">æ–¹æ¡ˆ3</span><input type="text" value="${state.planName3}" onchange="updateForm('planName3',this.value)" class="flex-1 p-2 border rounded-lg text-sm"/><input type="number" step="0.1" value="${state.multiplier3}" onchange="updateForm('multiplier3',this.value)" class="w-16 p-2 border rounded-lg text-sm text-center"/></div>`;
  html += '</div></div>';
  
  // åˆ—å°æŒ‰éˆ•
  html += '<button onclick="printDM()" class="w-full py-3 bg-navy text-white rounded-xl font-bold hover:bg-blue-900">ğŸ–¨ï¸ åˆ—å° / è¼¸å‡º PDF</button>';
  
  // è¿”å›è©¦ç®—ç³»çµ±
  html += '<a href="insurance-calculator-v7.html" class="block mt-3 text-center text-sm text-blue-500 hover:underline">â† è¿”å›è©¦ç®—ç³»çµ±</a>';
  
  return html;
}

// æ¸²æŸ“ DM é è¦½
function renderPreview() {
  const result = calculateDM();
  
  if (!result) {
    return `
      <div class="print-area bg-white shadow-2xl flex items-center justify-center" style="width:210mm;height:297mm;border:16px double #C5A059;">
        <div class="text-center">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-xl font-bold navy">è«‹é¸æ“‡å•†å“</p>
          <p class="text-gray-400 text-sm mt-2">Select a product to generate DM</p>
        </div>
      </div>
    `;
  }
  
  const { plans, hasSrv, isLateStart, survivalStartYear, survivalStartAge, payYears, currency } = result;
  const genderText = state.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
  const currencyIcon = currency === 'USD' ? 'ç¾å…ƒ' : 'å°å¹£';
  
  // ç´…åˆ©è¨­å®šæ–‡å­—
  const levelTextMap = {'high': 'é«˜åˆ†ç´…', 'medium': 'ä¸­åˆ†ç´…', 'low': 'ä½åˆ†ç´…', 'zero': 'é›¶åˆ†ç´…'};
  const levelText = levelTextMap[state.dividendLevel] || 'é«˜åˆ†ç´…';
  const methodText = state.dividendMethod || 'ç¹³æ¸…ä¿éšªé‡‘é¡';
  
  // ç”Ÿæˆè¡¨æ ¼è¡Œ
  let tableRows = '';
  
  // 1. æ¯å¹´å­˜å…¥
  tableRows += `<tr class="border-b border-amber-200/30">
    <td class="py-4 px-3 text-center font-bold navy">æ¯å¹´å­˜å…¥</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.annualPremium)}</td>`).join('')}
  </tr>`;
  
  // 2. ç´¯ç©ç¸½æŠ•å…¥
  tableRows += `<tr class="border-b border-amber-200/30">
    <td class="py-4 px-3 text-center font-bold navy">ç´¯ç©ç¸½æŠ•å…¥</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.totalDeposit)}</td>`).join('')}
  </tr>`;
  
  if (isLateStart && hasSrv) {
    // PFW/PAL/PFV/PF55/PF60/PF65 é¡å•†å“
    // å¾xxæ­²èµ·æ¯å¹´é ˜
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">å¾${survivalStartAge}æ­²èµ·æ¯å¹´é ˜</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.annualBenefit)}</td>`).join('')}
    </tr>`;
    
    // ~næ­²ç¸½é ˜
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">~${state.queryAge}æ­²ç¸½é ˜</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.cumulativeBenefit)}</td>`).join('')}
    </tr>`;
    
    // næ­²å¸³æˆ¶åƒ¹å€¼
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²å¸³æˆ¶åƒ¹å€¼</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
  } else if (hasSrv) {
    // PAC/PFE ç­‰æ—©æœŸé–‹å§‹é ˜å–å•†å“
    // 1~yå¹´ç¸½é ˜ï¼ˆæœ‰å€¼æ‰é¡¯ç¤ºï¼‰
    if (plans.some(p => p.payPeriodBenefit > 0)) {
      tableRows += `<tr class="border-b border-amber-200/30">
        <td class="py-4 px-3 text-center font-bold navy">1~${payYears}å¹´ç¸½é ˜</td>
        ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.payPeriodBenefit)}</td>`).join('')}
      </tr>`;
    }
    
    // æ»¿æœŸæ¯å¹´é ˜
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">æ»¿æœŸæ¯å¹´é ˜</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.annualBenefit)}</td>`).join('')}
    </tr>`;
    
    // 1~Nå¹´ç´¯ç©ç¸½é ˜
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">1~${state.queryAge - state.age}å¹´ç´¯ç©ç¸½é ˜</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.cumulativeBenefit)}</td>`).join('')}
    </tr>`;
    
    // næ­²è§£ç´„é‡‘
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è§£ç´„é‡‘</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
    // næ­²è³‡ç”¢ç¸½å€¼
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è³‡ç”¢ç¸½å€¼</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.totalAsset)}</td>`).join('')}
    </tr>`;
    
  } else {
    // ç´”å¢å€¼å‹å•†å“
    // ç¬¬Yå¹´å¸³æˆ¶åƒ¹å€¼
    tableRows += `<tr class="border-b border-amber-200/30 bg-amber-50">
      <td class="py-6 px-3 text-center font-bold text-white bg-navy rounded-l-xl">ç¬¬${payYears+1}å¹´å¸³æˆ¶åƒ¹å€¼</td>
      ${plans.map((p,i) => `<td class="py-6 text-center text-2xl font-black navy ${i===2?'bg-amber-100':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
    
    // næ­²è§£ç´„é‡‘
    tableRows += `<tr class="border-b border-amber-200/30">
      <td class="py-4 px-3 text-center font-bold navy">${state.queryAge}æ­²è§£ç´„é‡‘</td>
      ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.surrenderValue)}</td>`).join('')}
    </tr>`;
  }
  
  // èº«æ•…å°Šæ¦®å‚³æ‰¿
  tableRows += `<tr>
    <td class="py-4 px-3 text-center font-bold italic text-amber-800">èº«æ•…å°Šæ¦®å‚³æ‰¿</td>
    ${plans.map((p,i) => `<td class="py-4 text-center ${i===2?'bg-amber-50':''}">${formatMoney(p.deathBenefit)}</td>`).join('')}
  </tr>`;
  
  return `
    <div class="print-area bg-white shadow-2xl flex flex-col" style="width:210mm;height:297mm;border:16px double #C5A059;">
      <!-- Header 16% -->
      <div class="h-[16%] flex flex-col items-center justify-center text-center px-8 border-b-2 border-amber-300/50 bg-amber-50/50">
        <p class="gold font-bold tracking-[0.5em] text-sm mb-1">ELITE WEALTH MANAGEMENT</p>
        <h1 class="text-6xl font-black navy leading-tight">
          æ‚¨çš„é€€ä¼‘é‡‘<br/>
          <span class="inline-block w-20"></span><span class="gold italic">é‚„åœ¨ç¡è¦ºå—ï¼Ÿ</span>
        </h1>
        <div class="h-1 w-64 bg-gradient-to-r from-transparent via-amber-400 to-transparent mt-2"></div>
      </div>
      
      <!-- Icons 12% -->
      <div class="h-[12%] flex items-center justify-center gap-16 border-b border-amber-200/30 py-4">
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">$</span>
          </div>
          <p class="font-black navy text-lg">${currencyIcon}è³‡ç”¢</p>
          <p class="text-xs gold tracking-widest">GLOBAL ASSET</p>
        </div>
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">â†—</span>
          </div>
          <p class="font-black navy text-lg">ç©©å¥å¢å€¼</p>
          <p class="text-xs gold tracking-widest">BONUS VALUE</p>
        </div>
        <div class="text-center">
          <div class="w-14 h-14 mx-auto mb-2 rounded-full bg-navy flex items-center justify-center">
            <span class="text-2xl text-amber-300">ğŸ“…</span>
          </div>
          <p class="font-black navy text-lg">é€€ä¼‘è‡ªç”±</p>
          <p class="text-xs gold tracking-widest">RETIRE FREE</p>
        </div>
      </div>
      
      <!-- Table 62% -->
      <div class="h-[62%] px-6 py-4 flex flex-col">
        <div class="flex justify-between items-center mb-2">
          <div>
            <h2 class="text-4xl font-black navy"><span class="gold italic font-serif">The</span> Private Plan</h2>
            <p class="text-sm text-gray-500">${state.productData?.info?.fullName || ''}</p>
          </div>
          <div class="text-right">
            <div class="bg-navy text-amber-300 px-6 py-2 rounded-full font-bold">${state.age}æ­² ${genderText} è²´è³“å°ˆå±¬</div>
            <p class="text-sm gold mt-1">æŸ¥è©¢å¹´é½¡: ${state.queryAge}æ­² ï½œ ${payYears}å¹´æœŸ</p>
          </div>
        </div>
        <p class="text-xs text-purple-600 mb-2 text-right">ğŸ“Š å‡è¨­ï¼š${levelText} ï½œ ${methodText}</p>
        
        <div class="flex-1 border-2 border-amber-300/50 rounded-3xl overflow-hidden">
          <table class="w-full h-full">
            <thead>
              <tr class="bg-navy text-white">
                <th class="py-4 px-3 text-center font-bold w-[24%]">åˆ†æé …ç›®</th>
                <th class="py-4 text-center font-bold">${state.planName1}</th>
                <th class="py-4 text-center font-bold">${state.planName2}</th>
                <th class="py-4 text-center font-bold bg-blue-900">${state.planName3}</th>
              </tr>
            </thead>
            <tbody class="text-lg">
              ${tableRows}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Footer 10% -->
      <div class="h-[10%] flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 flex items-center justify-center opacity-5">
          <span class="text-[180px] font-black gold">URBAN</span>
        </div>
        <div class="relative text-center">
          <h3 class="text-4xl font-black gold italic tracking-widest">ç¾åœ¨æ±ºå®šãƒ»æœªä¾†æ›´è¼•é¬†</h3>
          <p class="text-xs text-gray-400 tracking-[0.3em] mt-1">PROFESSIONAL HERITAGE PLANNING ãƒ» URBAN OSâ„¢ DM DESIGNER</p>
        </div>
      </div>
    </div>
  `;
}

// ä¸»æ¸²æŸ“å‡½æ•¸
function render() {
  document.getElementById('controls').innerHTML = renderControls();
  document.getElementById('preview').innerHTML = renderPreview();
}

// å•Ÿå‹•
init();
</script>
</body>
</html>
