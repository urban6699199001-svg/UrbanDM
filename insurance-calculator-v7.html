<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿éšªå•†å“è©¦ç®—ç³»çµ± v7.28</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: #60a5fa; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .table-scroll { max-height: 500px; overflow-y: auto; }
    select option { background: #1e293b; color: white; }
    @media print { body { background: white !important; } .no-print { display: none !important; } .glass { background: white !important; } * { color: black !important; } }
    /* å›ºå®šè¡¨é ­èƒŒæ™¯ */
    thead.sticky-header th { background: #1e293b; position: sticky; top: 0; z-index: 10; }
    /* æ¯5å¹´åº•è‰² */
    tr.year-5n { background: rgba(59, 130, 246, 0.15) !important; }
    /* éƒ¨åˆ†è§£ç´„æ¨™ç¤º */
    tr.partial-surrender-row { background: rgba(249, 115, 22, 0.2) !important; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
<div id="app"></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBgBHsM92s9DH23uXDeo3EWQ5NjAM5nW0U",
  authDomain: "urban-os-v1.firebaseapp.com",
  databaseURL: "https://urban-os-v1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "urban-os-v1",
  storageBucket: "urban-os-v1.firebasestorage.app",
  messagingSenderId: "594831737040",
  appId: "1:594831737040:web:f16c007399bf16843f1ed5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const state = { 
  loading: true, error: null, step: 1, products: {}, selectedProduct: null, selectedPlan: null, rates: null,
  form: { name: '', gender: 'ç”·', birthDate: '', coverage: '', targetPremiumTWD: '', paymentMethod: 'é‡‘èæ©Ÿæ§‹è½‰å¸³', employeeDiscount: false, dividendLevel: 'medium', dividendMethod: '' },
  result: null, displayYears: 30,
  // åŒ¯ç‡è¨­å®š
  exchangeRateMode: 'fixed', // 'fixed' æˆ– 'yearly'
  exchangeRate: 32.5,        // å›ºå®šåŒ¯ç‡
  yearlyRates: {},           // é€å¹´åŒ¯ç‡ {1: 32.5, 2: 32.0, ...}
  showTWD: false,
  reducedPaidUpYear: 0,
  reducedPaidUpRatio: 0,
  // æœå°‹
  searchKeyword: '',
  // ğŸ†• éƒ¨åˆ†è§£ç´„è¨­å®š
  partialSurrenderMode: false,  // æ˜¯å¦å•Ÿç”¨éƒ¨åˆ†è§£ç´„
  partialSurrenders: []  // [{fromYear, toYear, amountPerYear}]
};

// å–å¾—æŒ‡å®šå¹´åº¦çš„åŒ¯ç‡
function getExchangeRate(year = 1) {
  if (state.exchangeRateMode === 'fixed') return state.exchangeRate;
  return state.yearlyRates[year] || state.exchangeRate;
}

// è¨­å®šåŒ¯ç‡æ¨¡å¼
function setExchangeRateMode(mode) {
  state.exchangeRateMode = mode;
  if (mode === 'yearly' && Object.keys(state.yearlyRates).length === 0) {
    // åˆå§‹åŒ–é€å¹´åŒ¯ç‡ï¼ˆé è¨­å‰10å¹´ï¼‰
    for (let i = 1; i <= 30; i++) {
      state.yearlyRates[i] = state.exchangeRate;
    }
  }
  render();
}

// è¨­å®šé€å¹´åŒ¯ç‡
function setYearlyRate(year, rate) {
  state.yearlyRates[year] = parseFloat(rate) || state.exchangeRate;
  render();
}

// æœå°‹å•†å“
function setSearchKeyword(keyword) {
  state.searchKeyword = keyword.toLowerCase();
  render();
}

// ğŸ†• éƒ¨åˆ†è§£ç´„å‡½æ•¸ï¼ˆv7.2: éœ€è¦é‡æ–°è¨ˆç®— benefitsï¼‰
function togglePartialSurrenderMode(enabled) {
  state.partialSurrenderMode = enabled;
  if (enabled && state.partialSurrenders.length === 0) {
    state.partialSurrenders.push({ fromYear: 10, toYear: 20, amountPerYear: 5 });
  }
  // âœ… v7.2: é‡æ–°è¨ˆç®—ï¼ˆå› ç‚ºéƒ¨åˆ†æé ˜æœƒåœ¨è¨ˆç®—éç¨‹ä¸­ç¸®æ¸› Nï¼‰
  if (state.result) doCalculate();
  else render();
}

function addPartialSurrender() {
  state.partialSurrenders.push({ fromYear: 10, toYear: 20, amountPerYear: 5 });
  if (state.result) doCalculate();
  else render();
}

function removePartialSurrender(idx) {
  state.partialSurrenders.splice(idx, 1);
  if (state.result) doCalculate();
  else render();
}

function updatePartialSurrender(idx, field, value) {
  state.partialSurrenders[idx][field] = parseFloat(value) || 0;
  // âœ… v7.2: é‡æ–°è¨ˆç®—
  if (state.result) doCalculate();
  else render();
}

// è¨ˆç®—éƒ¨åˆ†è§£ç´„å¾Œçš„åˆ©ç›Š
// âœ… v7.1 æ­£ç¢ºé‚è¼¯ï¼ˆå¾ N æºé ­ç¸®æ¸›ï¼Œé€£å‹•æ‰€æœ‰å€¼ï¼‰
// å·¥å» åšæ³•ï¼šéƒ¨åˆ†æé ˜ â†’ ç¸®æ¸›ç´¯è¨ˆä¿é¡ N â†’ Kã€Mã€è§£ç´„é‡‘ã€èº«æ•…é‡‘å…¨éƒ¨é€£å‹•æ¸›å°‘
// 
// æ­¥é©Ÿï¼š
// 1. è¨ˆç®—ç•¶å¹´è§£ç´„é‡‘ï¼ˆåŸºæ–¼ç•¶å‰ nRatioï¼‰
// 2. è¨ˆç®—ç¸®æ¸›æ¯”ä¾‹ = æé ˜é‡‘é¡ / ç•¶å¹´è§£ç´„é‡‘
// 3. nRatio = nRatio Ã— (1 - ç¸®æ¸›æ¯”ä¾‹)  â† ç´¯ç©ç¸®æ¸›
// 4. æ‰€æœ‰å€¼ä¹˜ä»¥ nRatio
function calculateWithPartialSurrender(benefits, surrenders, currency, originalCoverage, minCoverage) {
  if (!surrenders || surrenders.length === 0) return benefits;
  
  // å»ºç«‹è§£ç´„é‡‘é¡å°ç…§è¡¨ï¼ˆè¬TWDï¼‰
  const surrenderMap = {};
  for (const s of surrenders) {
    for (let y = s.fromYear; y <= s.toYear; y++) {
      surrenderMap[y] = (surrenderMap[y] || 0) + s.amountPerYear;
    }
  }
  
  let cumPartialSurrender = 0;  // ç´¯è¨ˆéƒ¨ä»½æé ˜é‡‘é¡ï¼ˆåŸå¹£ï¼‰
  let cumSurvivalAfter = 0;
  let nRatio = 1;  // âœ… N çš„ç´¯è¨ˆç¸®æ¸›æ¯”ä¾‹ï¼ˆæ ¸å¿ƒè®Šæ•¸ï¼‰
  
  const rate = state.exchangeRate;
  const isUSD = currency === 'USD';
  
  return benefits.map((row, idx) => {
    const year = row.year;
    const surrenderAmountWanTWD = surrenderMap[year] || 0;
    
    let partialSurrenderValue = 0;
    
    if (surrenderAmountWanTWD > 0) {
      // ç›®æ¨™æé ˜é‡‘é¡ï¼ˆè½‰åŸå¹£ï¼‰
      const targetValue = isUSD ? (surrenderAmountWanTWD * 10000 / rate) : (surrenderAmountWanTWD * 10000);
      
      // âœ… ç•¶å¹´è§£ç´„é‡‘ = åŸå§‹è§£ç´„é‡‘ Ã— nRatioï¼ˆåŸºæ–¼å·²ç¸®æ¸›çš„ Nï¼‰
      const currentSurrender = Math.round(row.surrenderTotal * nRatio);
      
      if (targetValue >= currentSurrender) {
        partialSurrenderValue = Math.max(0, currentSurrender);
      } else {
        partialSurrenderValue = targetValue;
      }
      
      // âœ… é—œéµï¼šç¸®æ¸› nRatioï¼ˆæ¨¡æ“¬ç¸®æ¸› Nï¼‰
      if (currentSurrender > 0 && partialSurrenderValue > 0) {
        const reductionRatio = partialSurrenderValue / currentSurrender;
        nRatio = nRatio * (1 - reductionRatio);
      }
      
      cumPartialSurrender += partialSurrenderValue;
    }
    
    // âœ… æ‰€æœ‰å€¼éƒ½åŸºæ–¼ nRatio è¨ˆç®—ï¼ˆæ¨¡æ“¬ N ç¸®æ¸›çš„é€£å‹•æ•ˆæœï¼‰
    const survivalAfter = Math.round(row.survival * nRatio);
    cumSurvivalAfter += survivalAfter;
    const deathTotalAfter = Math.round(row.deathTotal * nRatio);
    const surrenderTotalAfter = Math.round(row.surrenderTotal * nRatio);
    
    return {
      ...row,
      partialSurrenderValue,
      cumPartialSurrender,
      remainingRatio: nRatio,  // âœ… ä½¿ç”¨ç´¯è¨ˆ nRatio
      survivalAfter,
      cumSurvivalAfter,
      deathTotalAfter,
      surrenderTotalAfter,
      annualPremiumAfter: row.annualPremium,
      hasPartialSurrender: partialSurrenderValue > 0
    };
  });
}

function getMaxCoverageByAge(product, age) {
  if (!product?.info?.coverageLimitsByAge) return product?.info?.maxCoverage || 200;
  const limits = product.info.coverageLimitsByAge;
  return limits[String(age)] || product.info.maxCoverage || 200;
}

function calculatePremium(gpRate, coverage, paymentMethod, isEmployee, productCode, payYears, discountInfo) {
  const original = Math.round(gpRate * coverage * 10) / 10;
  let basePremium = productCode.startsWith('PFV') ? Math.floor(original) : Math.round(original);
  
  let discount = 0;
  
  // â˜…â˜…â˜… é«˜ä¿é¡æŠ˜æ‰£ï¼šå„ªå…ˆä½¿ç”¨ç”¢å“è³‡æ–™ä¸­çš„éšæ¢¯è¡¨ â˜…â˜…â˜…
  if (discountInfo?.highCoverageTiers?.length > 0) {
    for (const tier of discountInfo.highCoverageTiers) {
      if (coverage >= tier.minCoverage) {
        discount += tier.discount;
        break;
      }
    }
  } else {
    // å‚™ç”¨ï¼šç¡¬ç·¨ç¢¼é‚è¼¯ï¼ˆèˆŠç‰ˆç¾é‡‘å•†å“ï¼‰
    if (productCode.startsWith('PFW') || productCode.startsWith('PF5') || productCode.startsWith('PF6')) {
      if (coverage >= 65) discount += 0.03;
      else if (coverage >= 25) discount += 0.02;
      else if (coverage >= 8) discount += 0.01;
    } else if (productCode.startsWith('PFV')) {
      if (payYears === 2) {
        if (coverage >= 20) discount += 0.03;
        else if (coverage >= 10) discount += 0.02;
        else if (coverage >= 3) discount += 0.01;
      } else {
        if (coverage >= 30) discount += 0.03;
        else if (coverage >= 15) discount += 0.02;
        else if (coverage >= 5) discount += 0.01;
      }
    } else if (productCode.startsWith('PFD')) {
      if (coverage >= 50) discount += 0.02;
      else if (coverage >= 20) discount += 0.01;
    } else if (productCode === 'PFC') {
      if (payYears === 6) {
        if (coverage >= 20) discount += 0.015;
        else if (coverage >= 15) discount += 0.01;
        else if (coverage >= 5) discount += 0.005;
      } else if (payYears === 3) {
        if (coverage >= 8) discount += 0.015;
        else if (coverage >= 6) discount += 0.01;
        else if (coverage >= 2) discount += 0.005;
      }
    }
  }
  
  // â˜…â˜…â˜… ç¹³è²»æ–¹å¼æŠ˜æ‰£ï¼šå„ªå…ˆä½¿ç”¨ç”¢å“è³‡æ–™ â˜…â˜…â˜…
  if (discountInfo?.paymentMethods?.[paymentMethod]) {
    discount += discountInfo.paymentMethods[paymentMethod].first || 0;
  } else if (paymentMethod === 'é‡‘èæ©Ÿæ§‹è½‰å¸³') {
    discount += 0.01;
  }
  
  // å“¡å·¥æŠ˜æ‰£
  if (isEmployee) discount += (productCode.startsWith('PFW') || productCode.startsWith('PF5') || productCode.startsWith('PF6')) ? 0.08 : 0.01;
  
  // â˜…â˜…â˜… æŠ˜æ‰£ä¸Šé™ï¼šä½¿ç”¨ç”¢å“è³‡æ–™ â˜…â˜…â˜…
  const maxDiscount = discountInfo?.maxDiscount || (isEmployee ? 0.11 : 0.04);
  discount = Math.min(discount, maxDiscount);
  
  return { basePremium, actualPremium: Math.round(basePremium * (1 - discount)), discountRate: discount * 100 };
}

// âœ… v7.19 æ··åˆé€²ä½åˆ¶ (Hybrid Rounding)
// ã€Gemini å»ºè­°ä¿®æ­£ã€‘
// 1. ä¿é¡è¨ˆç®—ï¼ˆN, paidUpThisYearï¼‰â†’ Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
// 2. ç¾é‡‘è¨ˆç®—ï¼ˆè§£ç´„é‡‘çµ„ä»¶ï¼‰â†’ Math.roundï¼ˆå››æ¨äº”å…¥ï¼‰
// 3. ç¸®æ¸›é †åºï¼šcurN = (prevN + paidUpThisYear_Full) Ã— K
function calculateBenefits(key, coverage, payYears, rates, dividendLevel, premium, dividendMethod, storedInterestRate = 0.0265, partialSurrenders = [], currency = 'USD') {
  const bonuSuffix = (dividendLevel === 'low' || dividendLevel === 'zero') ? '1' : '2';
  const bonuKey = key + bonuSuffix;
  const isZeroDividend = dividendLevel === 'zero';
  
  const cvRates = rates.cv?.[key] || [];
  const dieRates = rates.die?.[key] || [];
  const die2Rates = rates.die2?.[key] || [];
  const srvRates = rates.srv?.[key] || [];
  const pvfbRates = rates.pvfb?.[key] || [];
  const pvfb0Rates = rates.pvfb0?.[key] || [];
  const bonuRates = rates.bonu?.[bonuKey] || [];
  const bonuDieRates = rates.bonudie?.[bonuKey] || rates.bonu_die?.[bonuKey] || [];
  const bonuCvRates = rates.bonucv?.[bonuKey] || rates.bonu_cv?.[bonuKey] || [];
  const paRates = rates.pa?.[key] || [];
  
  const isCashDividend = dividendMethod === 'ç¾é‡‘çµ¦ä»˜';
  const isStoredInterest = dividendMethod === 'å„²å­˜ç”Ÿæ¯';
  const isPaidUp = !isCashDividend && !isStoredInterest;
  
  const monthlyRate = storedInterestRate / 12;
  const annualFactor = Math.pow(1 + monthlyRate, 12);
  
  const isUSD = currency === 'USD';
  const rate = state.exchangeRate || 31.5;
  
  // å»ºç«‹æé ˜æ˜ å°„è¡¨ï¼ˆå–®ä½ï¼šTWDï¼‰
  const surrenderMapTWD = {};
  for (const s of (partialSurrenders || [])) {
    for (let y = s.fromYear; y <= s.toYear; y++) {
      const amountTWD = s.amountPerYear * 10000;
      surrenderMapTWD[y] = (surrenderMapTWD[y] || 0) + amountTWD;
    }
  }
  
  const benefits = [];
  let cumPremium = 0, cumSurvival = 0;
  let cumStoredDividend = 0;
  let cumPartialSurrenderTWD = 0;
  
  // ç´¯è¨ˆç¸®æ¸›å› å­
  let cumulativeReductionFactor = 1.0;
  
  // ç¶­è­·ç´¯è¨ˆç¹³æ¸…ä¿é¡
  let reducedCumPaidUp = 0;
  let prevReducedCumPaidUp = 0;
  
  // âœ… v7.19ï¼šè¨˜éŒ„å‰ä¸€å¹´æœ«è§£ç´„é‡‘ï¼ˆç”¨æ–¼è¨ˆç®—ç¸®æ¸›æ¯”ä¾‹ï¼‰
  let prevYearEndSurrenderTWD = 0;
  
  for (let year = 1; year <= 75; year++) {
    const idx = year - 1;
    const annualPremium = year <= payYears ? premium : 0;
    cumPremium += annualPremium;
    
    const paRate = paRates[idx] || 0;
    const reducedPaidUpAmount = paRate ? Math.ceil(paRate * coverage) : 0;
    
    // å–å¾—ç•¶å¹´æé ˜é‡‘é¡
    const withdrawalTWD = surrenderMapTWD[year] || 0;
    
    // âœ… v7.19ï¼šå¹´åˆè¨ˆç®—ç¸®æ¸›æ¯”ä¾‹
    let reductionRatio = 0;
    let thisYearK = 1;  // ç•¶å¹´çš„ä¿ç•™æ¯”ä¾‹
    if (withdrawalTWD > 0 && prevYearEndSurrenderTWD > 0) {
      reductionRatio = withdrawalTWD / prevYearEndSurrenderTWD;
      thisYearK = 1 - reductionRatio;
    }
    
    // ====== æ­¥é©Ÿ 1ï¼šè¨ˆç®—ç•¶å¹´å€¼ ======
    // âœ… v7.19ï¼šç´…åˆ©æ˜¯åŸºæ–¼å‰ä¸€å¹´çš„è²¢ç»ï¼Œä¸å—ç•¶å¹´ç¸®æ¸›å½±éŸ¿
    
    // è¨ˆç®—ç•¶å¹´ç´…åˆ© Kï¼ˆç”¨ç´¯è¨ˆå› å­ï¼Œä½†ä¸ä¹˜ thisYearKï¼‰
    const bonuRate = isZeroDividend ? 0 : (bonuRates[idx] || 0);
    let kBase = bonuRate ? Math.round(bonuRate * coverage * cumulativeReductionFactor) : 0;
    
    // âœ… v7.19ï¼škAdded åŸºæ–¼å‰ä¸€å¹´æœ«çš„ prevReducedCumPaidUpï¼Œä¸å—ç•¶å¹´ç¸®æ¸›å½±éŸ¿
    let kAdded = 0;
    if (isPaidUp && prevReducedCumPaidUp && bonuRate) {
      kAdded = Math.round(prevReducedCumPaidUp * bonuRate / 10000);
    }
    const annualDividendK = kBase + kAdded;
    
    if (isStoredInterest) {
      if (year === 1) {
        cumStoredDividend = kBase;
      } else {
        cumStoredDividend = Math.round(cumStoredDividend * annualFactor + kBase);
      }
    }
    
    // è¨ˆç®—ç•¶å¹´ç¹³æ¸…ä¿é¡ M - âœ… v7.19ï¼šç”¨ Math.ceilï¼ˆä¿é¡è¨ˆç®—ï¼‰
    let paidUpThisYear = 0;
    if (isPaidUp) {
      const pvfbNext = pvfbRates[year] || 0;
      paidUpThisYear = (annualDividendK > 0 && pvfbNext > 0) ? Math.ceil(annualDividendK / pvfbNext * 10000) : 0;
    }
    
    // âœ… v7.19ï¼šcurN ç”¨ Math.ceilï¼ˆä¿é¡è¨ˆç®—ï¼‰
    // curN = (prevN + paidUpThisYear_Full) Ã— K
    let tempReducedCumPaidUp = Math.ceil((prevReducedCumPaidUp + paidUpThisYear) * thisYearK);
    
    // è¨ˆç®—ç”Ÿå­˜é‡‘ï¼ˆç•¶å¹´æé ˜æ™‚ï¼ŒåŸºæœ¬ä¿é¡çµ„ä»¶ä¹Ÿè¦ç¸®æ¸›ï¼‰
    const srvRate = srvRates[idx] || 0;
    const survivalF = srvRate ? Math.round(srvRate * coverage * cumulativeReductionFactor * thisYearK) : 0;
    const survivalO = (isPaidUp && srvRate && tempReducedCumPaidUp) ? Math.round(srvRate * tempReducedCumPaidUp / 10000) : 0;
    
    let survival;
    if (isCashDividend) {
      survival = survivalF + kBase;
    } else if (isStoredInterest) {
      survival = survivalF;
    } else {
      survival = survivalF + survivalO;
    }
    
    // è¨ˆç®—èº«æ•…é‡‘ - ç•¶å¹´æé ˜æ™‚ï¼ŒåŸºæœ¬ä¿é¡çµ„ä»¶ä¹Ÿè¦ç¸®æ¸›
    const dieRate = dieRates[idx] || 0;
    const deathA = dieRate ? Math.round(dieRate * coverage * cumulativeReductionFactor * thisYearK) : 0;
    const die2Rate = die2Rates[idx] || 0;
    const deathD = (isPaidUp && tempReducedCumPaidUp && die2Rate) ? Math.round(tempReducedCumPaidUp * die2Rate / 10000) : 0;
    const bonuDieRate = isZeroDividend ? 0 : (bonuDieRates[idx] || 0);
    const deathX = bonuDieRate ? Math.round(bonuDieRate * coverage * cumulativeReductionFactor * thisYearK) : 0;
    
    let deathTotalNoWithdraw;
    if (isCashDividend) {
      deathTotalNoWithdraw = deathA + kBase + deathX;
    } else if (isStoredInterest) {
      deathTotalNoWithdraw = deathA + cumStoredDividend + deathX;
    } else {
      deathTotalNoWithdraw = deathA + deathD + deathX;
    }
    
    // è¨ˆç®—è§£ç´„é‡‘ - ç•¶å¹´æé ˜æ™‚ï¼ŒåŸºæœ¬ä¿é¡çµ„ä»¶ä¹Ÿè¦ç¸®æ¸›
    const cvRate = cvRates[idx] || 0;
    const surrenderB = cvRate ? Math.round(cvRate * coverage * cumulativeReductionFactor * thisYearK) : 0;
    const pvfb0Next = pvfb0Rates[year] || 0;
    const surrenderE = (isPaidUp && tempReducedCumPaidUp && pvfb0Next) ? Math.round(tempReducedCumPaidUp * pvfb0Next / 10000) : 0;
    const bonuCvRate = isZeroDividend ? 0 : (bonuCvRates[idx] || 0);
    const surrenderY = bonuCvRate ? Math.round(bonuCvRate * coverage * cumulativeReductionFactor * thisYearK) : 0;
    
    // âœ… v7.19ï¼šè§£ç´„é‡‘å·²ç¶“æ˜¯ç¸®æ¸›å¾Œçš„å€¼
    let surrenderTotal;
    if (isCashDividend) {
      surrenderTotal = surrenderB + kBase + surrenderY;
    } else if (isStoredInterest) {
      surrenderTotal = surrenderB + cumStoredDividend + surrenderY;
    } else {
      surrenderTotal = surrenderB + surrenderE + surrenderY;
    }
    
    // è½‰æˆ TWD
    let surrenderTotalTWD = isUSD ? Math.round(surrenderTotal * rate) : surrenderTotal;
    let deathTotalTWD = isUSD ? Math.round(deathTotalNoWithdraw * rate) : deathTotalNoWithdraw;
    
    // ====== æ­¥é©Ÿ 2ï¼šè¨˜éŒ„æé ˜é‡‘é¡ï¼ˆä½†ä¸å¾è§£ç´„é‡‘æ‰£é™¤ï¼‰======
    // âœ… v7.19ï¼šæ ¹æ“š Gemini åˆ†æï¼Œè§£ç´„é‡‘ = ç¸®æ¸›å¾Œå‰©é¤˜ä¿å–®åƒ¹å€¼
    // ç”¨æˆ¶é ˜å–çš„é‡‘é¡æ˜¯ã€Œå¹´åˆçµç®—ã€ï¼Œä¸å¾å¹´æœ«è§£ç´„é‡‘æ‰£é™¤
    let actualWithdrawalTWD = 0;
    const beforeReductionCumPaidUp = tempReducedCumPaidUp;
    
    if (withdrawalTWD > 0) {
      // å¯¦éš›æé ˜é‡‘é¡ = å‰ä¸€å¹´æœ«è§£ç´„é‡‘ Ã— Rï¼ˆå¹´åˆçµç®—ï¼‰
      actualWithdrawalTWD = withdrawalTWD;
      
      // âœ… v7.19ï¼šè§£ç´„é‡‘æ¬„ä½é¡¯ç¤ºã€Œç¸®æ¸›å¾Œå‰©é¤˜ä¿å–®åƒ¹å€¼ã€
      // ä¸éœ€è¦å†æ¸›æé ˜ï¼Œå› ç‚ºæé ˜æ˜¯å¹´åˆçµç®—çš„
      // surrenderTotalTWD ä¿æŒä¸è®Š
      
      // æ›´æ–°ç´¯è¨ˆå› å­ï¼ˆç”¨æ–¼ä¸‹ä¸€å¹´ï¼‰
      cumulativeReductionFactor *= thisYearK;
      
      cumPartialSurrenderTWD += actualWithdrawalTWD;
    }
    
    // æ›´æ–° reducedCumPaidUp
    reducedCumPaidUp = tempReducedCumPaidUp;
    
    cumSurvival += survival;
    
    // è½‰å›åŸå¹£
    const deathTotalFinal = isUSD ? Math.round(deathTotalTWD / rate) : deathTotalTWD;
    const surrenderTotalFinal = isUSD ? Math.round(surrenderTotalTWD / rate) : surrenderTotalTWD;
    const withdrawalDisplayValue = isUSD ? Math.round(actualWithdrawalTWD / rate) : actualWithdrawalTWD;
    const cumWithdrawalDisplayValue = isUSD ? Math.round(cumPartialSurrenderTWD / rate) : cumPartialSurrenderTWD;
    
    // ä¿å­˜è¨ºæ–·å€¼
    benefits.push({ 
      year, annualPremium, cumPremium, 
      paRate, reducedPaidUpAmount,
      survival, cumSurvival,
      annualDividend: kBase,
      deathTotal: deathTotalFinal,
      surrenderTotal: surrenderTotalFinal,
      partialSurrenderValue: withdrawalDisplayValue,
      cumPartialSurrender: cumWithdrawalDisplayValue,
      partialSurrenderTWD: actualWithdrawalTWD,
      cumPartialSurrenderTWD: cumPartialSurrenderTWD,
      cumPaidUp: reducedCumPaidUp,
      hasPartialSurrender: actualWithdrawalTWD > 0,
      reductionRatio,
      cumulativeReductionFactor,
      _debug: {
        kBase, kAdded, annualDividendK,
        paidUpThisYear,
        prevReducedCumPaidUp,
        beforeReductionCumPaidUp,
        deathA, deathD, deathX,
        surrenderB, surrenderE, surrenderY,
        deathNoWithdraw: deathTotalNoWithdraw,
        surrenderNoWithdraw: surrenderTotal,
        deathTotalTWD,
        surrenderTotalTWD,
        // v7.19ï¼šç„¡æé ˜è§£ç´„é‡‘TWDï¼ˆç”¨æ–¼è¨ºæ–·ï¼‰
        surrenderNoWithdrawTWD: surrenderTotalTWD,
        prevYearEndSurrenderTWD,
        thisYearK,
      }
    });
    
    // âœ… v7.19ï¼šæ›´æ–°å‰ä¸€å¹´æœ«è§£ç´„é‡‘ï¼ˆæé ˜å¾Œçš„å€¼ï¼‰
    prevYearEndSurrenderTWD = surrenderTotalTWD;
    prevReducedCumPaidUp = reducedCumPaidUp;
  }
  
  return benefits;
}

async function loadProducts() {
  state.loading = true; render();
  try {
    const snap = await db.ref('products').once('value');
    const data = snap.val();
    if (!data) throw new Error('è³‡æ–™åº«ç‚ºç©º');
    for (const [code, prod] of Object.entries(data)) {
      state.products[code] = { 
        code, 
        info: prod.info, 
        plans: prod.plans,
        dividendOptions: prod.info?.dividendOptions || ['ç¹³æ¸…ä¿éšªé‡‘é¡']
      };
    }
    state.loading = false; state.error = null;
  } catch (e) { state.loading = false; state.error = e.message; }
  render();
}

async function loadRates(productCode) {
  state.loading = true; render();
  try {
    const snap = await db.ref('products/' + productCode + '/rates').once('value');
    state.rates = snap.val();
    state.loading = false;
  } catch (e) { state.loading = false; state.error = e.message; }
  render();
}

function getInsuranceAge() {
  const bd = state.form.birthDate;
  if (!bd || bd.length < 7) return null;
  
  // è§£ææ ¼å¼ï¼šYYYMMDDï¼ˆå¦‚ 1040101 æˆ– 0840101ï¼‰
  const padded = bd.padStart(7, '0');
  const birthYear = parseInt(padded.substring(0, 3));
  const birthMonth = parseInt(padded.substring(3, 5));
  const birthDay = parseInt(padded.substring(5, 7));
  
  if (!birthYear || !birthMonth || !birthDay) return null;
  if (birthMonth < 1 || birthMonth > 12 || birthDay < 1 || birthDay > 31) return null;
  
  // è½‰æ›æ°‘åœ‹å¹´ç‚ºè¥¿å…ƒå¹´
  const birthDateWest = new Date(birthYear + 1911, birthMonth - 1, birthDay);
  const today = new Date();
  
  // è¨ˆç®—è¶³æ­²
  let age = today.getFullYear() - birthDateWest.getFullYear();
  const monthDiff = today.getMonth() - birthDateWest.getMonth();
  const dayDiff = today.getDate() - birthDateWest.getDate();
  
  // å¦‚æœé‚„æ²’éç”Ÿæ—¥ï¼Œæ¸›ä¸€æ­²
  if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
    age--;
  }
  
  // ä¿éšªå¹´é½¡è¨ˆç®—ï¼šåŠå¹´å¤šä¸€æ­²
  // è¨ˆç®—è·é›¢ä¸‹æ¬¡ç”Ÿæ—¥çš„æœˆæ•¸
  let monthsToNextBirthday;
  if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
    monthsToNextBirthday = -monthDiff + (dayDiff < 0 ? -1 : 0);
  } else {
    monthsToNextBirthday = 12 - monthDiff + (dayDiff > 0 ? -1 : 0);
  }
  
  // å¦‚æœè·é›¢ä¸‹æ¬¡ç”Ÿæ—¥ä¸åˆ°6å€‹æœˆï¼Œä¿éšªå¹´é½¡+1
  if (monthsToNextBirthday <= 6) {
    age++;
  }
  
  return age;
}

// è¨ˆç®—ä¿è²»æ›ç®—ä¿é¡ï¼ˆè¼¸å…¥å°å¹£ï¼Œè‡ªå‹•æ›ç®—ï¼‰
function calculateCoverageFromPremium() {
  const targetTWD = parseFloat(state.form.targetPremiumTWD);
  if (!targetTWD || targetTWD <= 0) return;
  
  const age = getInsuranceAge();
  const plan = state.selectedPlan;
  const prod = state.selectedProduct;
  if (!age || !plan || !prod || !state.rates?.gp) return;
  
  const isUSD = prod.info?.currency === 'USD';
  // å¦‚æœæ˜¯ç¾å…ƒå•†å“ï¼Œå°‡å°å¹£æ›ç®—æˆç¾å…ƒ
  const targetPremium = isUSD ? (targetTWD / state.exchangeRate) : targetTWD;
  
  const genderCode = state.form.gender === 'ç”·' ? '01' : '02';
  const key = plan.prefix + genderCode + age.toString().padStart(2, '0');
  const gpRate = state.rates.gp[key];
  if (!gpRate) return;
  
  // åç®—ä¿é¡
  let estimatedCov = targetPremium / gpRate;
  
  // è¿­ä»£èª¿æ•´ï¼ˆè€ƒæ…®æŠ˜æ‰£ï¼‰
  for (let i = 0; i < 5; i++) {
    const premiumInfo = calculatePremium(gpRate, estimatedCov, state.form.paymentMethod, state.form.employeeDiscount, prod.code, plan.payYears, prod.info.discounts);
    const diff = targetPremium - premiumInfo.actualPremium;
    if (Math.abs(diff) < 1) break;
    estimatedCov += diff / gpRate;
  }
  
  // å–æ•´åˆ°å°æ•¸é»ä¸€ä½
  estimatedCov = Math.round(estimatedCov * 10) / 10;
  
  // æª¢æŸ¥ä¿é¡ç¯„åœ
  const minCov = prod.info.minCoverage;
  const maxCov = getMaxCoverageByAge(prod, age);
  estimatedCov = Math.max(minCov, Math.min(maxCov, estimatedCov));
  
  state.form.coverage = estimatedCov;
  render();
}

function doCalculate() {
  const age = getInsuranceAge(), cov = parseFloat(state.form.coverage) || 0, plan = state.selectedPlan, prod = state.selectedProduct;
  if (!age || !cov || !plan || !state.rates) { state.error = 'è«‹å®Œæ•´å¡«å¯«è³‡æ–™'; render(); return; }
  if (age < plan.minAge || age > plan.maxAge) { state.error = 'å¹´é½¡ä¸ç¬¦åˆæ­¤æ–¹æ¡ˆ (' + plan.minAge + '~' + plan.maxAge + 'æ­²)'; render(); return; }
  
  const minCov = prod.info.minCoverage;
  const maxCov = getMaxCoverageByAge(prod, age);
  if (cov < minCov || cov > maxCov) { state.error = 'ä¿é¡éœ€åœ¨ ' + minCov + '~' + maxCov + ' è¬ä¹‹é–“ï¼ˆ' + age + 'æ­²é™åˆ¶ï¼‰'; render(); return; }
  
  const genderCode = state.form.gender === 'ç”·' ? '01' : '02';
  const key = plan.prefix + genderCode + age.toString().padStart(2, '0');
  
  if (!state.rates.gp?.[key]) { state.error = 'æ‰¾ä¸åˆ°è²»ç‡ ' + key; render(); return; }
  
  const gpRate = state.rates.gp[key];
  const premiumInfo = calculatePremium(gpRate, cov, state.form.paymentMethod, state.form.employeeDiscount, prod.code, plan.payYears, prod.info.discounts);
  const storedInterestRate = prod.info?.storedInterestRate || 0.0265;
  const currency = prod.info.currency || 'TWD';
  
  // âœ… v7.2: å‚³å…¥éƒ¨åˆ†æé ˜è¨­å®šï¼Œè®“ N åœ¨è¨ˆç®—éç¨‹ä¸­ç¸®æ¸›
  const partialSurrenders = state.partialSurrenderMode ? state.partialSurrenders : [];
  const benefits = calculateBenefits(key, cov, plan.payYears, state.rates, state.form.dividendLevel, premiumInfo.actualPremium, state.form.dividendMethod, storedInterestRate, partialSurrenders, currency);
  
  state.result = {
    key, product: prod, plan, age, coverage: cov,
    name: state.form.name || 'å®¢æˆ¶', gender: state.form.gender, 
    dividendLevel: state.form.dividendLevel,
    dividendMethod: state.form.dividendMethod,  // ç´…åˆ©çµ¦ä»˜æ–¹å¼
    basePremium: premiumInfo.basePremium, actualPremium: premiumInfo.actualPremium, discountRate: premiumInfo.discountRate,
    benefits, currency: prod.info.currency || 'TWD'
  };
  state.error = null; state.step = 3; render();
}

// çµæœé å¿«é€Ÿæ›´æ–°ï¼ˆä¿®æ”¹å¾Œè‡ªå‹•é‡æ–°è¨ˆç®—ï¼‰
function quickUpdate(field, value) {
  state.form[field] = field === 'coverage' ? parseFloat(value) : (field === 'birthYear' ? parseInt(value) : value);
  doCalculate();
}

function formatCurrency(value, currency, year = null) {
  if (value === null || value === undefined) return '-';
  if (currency === 'USD' && state.showTWD) {
    const rate = year ? getExchangeRate(year) : state.exchangeRate;
    return Math.round(value * rate).toLocaleString();
  }
  return value.toLocaleString();
}

function render() {
  const app = document.getElementById('app');
  if (state.loading) { app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="spinner mx-auto"></div></div>'; return; }
  if (state.error && state.step === 1) { app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="glass rounded-2xl p-8 text-center"><p class="text-red-300 mb-4">' + state.error + '</p><button onclick="loadProducts()" class="px-6 py-2 bg-blue-500 text-white rounded-lg">é‡è©¦</button></div></div>'; return; }
  let c = '';
  if (state.step === 1) c = renderStep1();
  else if (state.step === 2) c = renderStep2();
  else if (state.step === 3) c = renderStep3();
  app.innerHTML = '<div class="bg-black/20 p-4 no-print"><h1 class="text-xl font-bold text-white text-center">ä¿éšªå•†å“è©¦ç®—ç³»çµ± <span class="text-sm text-blue-300">v7</span> <span class="text-xs text-orange-300">å«éƒ¨åˆ†è§£ç´„</span></h1></div><div class="p-4">' + c + '</div>';
}

function renderStep1() {
  const prods = Object.values(state.products);
  const keyword = state.searchKeyword;
  
  // ç¯©é¸å•†å“
  const filteredProds = keyword ? prods.filter(p => {
    const searchText = (p.info.name + ' ' + p.code + ' ' + (p.info.fullName || '')).toLowerCase();
    return searchText.includes(keyword);
  }) : prods;
  
  const twdProds = filteredProds.filter(p => p.info.currency !== 'USD');
  const usdProds = filteredProds.filter(p => p.info.currency === 'USD');
  const hasUSD = prods.some(p => p.info.currency === 'USD');
  
  let html = '<div class="max-w-4xl mx-auto"><h2 class="text-2xl font-bold text-white text-center mb-6">é¸æ“‡å•†å“</h2>';
  
  // åŒ¯ç‡è¨­å®šå€ï¼ˆåªæœ‰ç¾å…ƒå•†å“æ™‚é¡¯ç¤ºï¼‰
  if (hasUSD) {
    html += '<div class="glass rounded-xl p-4 mb-6">';
    html += '<div class="flex items-center justify-between flex-wrap gap-4">';
    html += '<div class="flex items-center gap-4">';
    html += '<span class="text-blue-200">ğŸ’± åŒ¯ç‡è¨­å®š</span>';
    html += '<label class="flex items-center gap-1"><input type="radio" name="rateMode" value="fixed" ' + (state.exchangeRateMode === 'fixed' ? 'checked' : '') + ' onchange="setExchangeRateMode(\'fixed\')"/><span class="text-white text-sm">å›ºå®šåŒ¯ç‡</span></label>';
    html += '<label class="flex items-center gap-1"><input type="radio" name="rateMode" value="yearly" ' + (state.exchangeRateMode === 'yearly' ? 'checked' : '') + ' onchange="setExchangeRateMode(\'yearly\')"/><span class="text-white text-sm">é€å¹´åŒ¯ç‡</span></label>';
    html += '</div>';
    
    if (state.exchangeRateMode === 'fixed') {
      html += '<div class="flex items-center gap-2">';
      html += '<span class="text-white text-sm">1 USD =</span>';
      html += '<input type="number" value="' + state.exchangeRate + '" onchange="setExchangeRate(this.value)" step="0.1" class="w-20 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm text-center"/>';
      html += '<span class="text-white text-sm">TWD</span>';
      html += '</div>';
    }
    html += '</div>';
    
    // é€å¹´åŒ¯ç‡è¨­å®š
    if (state.exchangeRateMode === 'yearly') {
      html += '<div class="mt-4 p-3 bg-white/5 rounded-lg">';
      html += '<p class="text-sm text-blue-200 mb-2">è¨­å®šå„å¹´åº¦åŒ¯ç‡ï¼ˆæœªè¨­å®šå¹´åº¦ä½¿ç”¨å›ºå®šåŒ¯ç‡ ' + state.exchangeRate + 'ï¼‰</p>';
      html += '<div class="grid grid-cols-5 md:grid-cols-10 gap-2">';
      for (let y = 1; y <= 20; y++) {
        const rate = state.yearlyRates[y] || state.exchangeRate;
        html += '<div class="text-center">';
        html += '<div class="text-xs text-white/50 mb-1">ç¬¬' + y + 'å¹´</div>';
        html += '<input type="number" value="' + rate + '" onchange="setYearlyRate(' + y + ',this.value)" step="0.1" class="w-full px-1 py-1 bg-white/10 border border-white/20 rounded text-white text-xs text-center"/>';
        html += '</div>';
      }
      html += '</div></div>';
    }
    html += '</div>';
  }
  
  // æœå°‹æ¬„
  html += '<div class="mb-6">';
  html += '<input type="text" value="' + (state.searchKeyword || '') + '" oninput="setSearchKeyword(this.value)" placeholder="ğŸ” æœå°‹å•†å“ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50"/>';
  html += '</div>';
  
  if (filteredProds.length === 0) {
    html += '<p class="text-center text-white/50 py-8">æ‰¾ä¸åˆ°ç¬¦åˆã€Œ' + keyword + 'ã€çš„å•†å“</p>';
  }
  
  if (twdProds.length) {
    html += '<h3 class="text-lg text-blue-200 mb-3">ğŸ’´ å°å¹£å•†å“</h3><div class="grid md:grid-cols-2 gap-4 mb-6">';
    html += twdProds.map(p => '<div onclick="selectProduct(\'' + p.code + '\')" class="glass rounded-xl p-5 cursor-pointer hover:bg-white/20"><h3 class="text-lg font-bold text-white">' + p.info.name + ' <span class="text-sm text-blue-300">' + p.code + '</span></h3><p class="text-blue-200 text-sm">' + (p.info.fullName || '') + '</p><p class="text-white/70 text-sm mt-2">ä¿é¡ï¼š' + p.info.minCoverage + '~' + p.info.maxCoverage + ' è¬</p></div>').join('');
    html += '</div>';
  }
  
  if (usdProds.length) {
    html += '<h3 class="text-lg text-blue-200 mb-3">ğŸ’µ ç¾å…ƒå•†å“</h3><div class="grid md:grid-cols-2 gap-4">';
    html += usdProds.map(p => '<div onclick="selectProduct(\'' + p.code + '\')" class="glass rounded-xl p-5 cursor-pointer hover:bg-white/20 border border-green-500/30"><h3 class="text-lg font-bold text-white">' + p.info.name + ' <span class="text-sm text-green-300">' + p.code + '</span></h3><p class="text-blue-200 text-sm">' + (p.info.fullName || '') + '</p><p class="text-white/70 text-sm mt-2">ä¿é¡ï¼š' + p.info.minCoverage + '~' + p.info.maxCoverage + ' è¬ USD</p></div>').join('');
    html += '</div>';
  }
  
  html += '</div>';
  return html;
}

function renderStep2() {
  const prod = state.selectedProduct, plans = Object.entries(prod.plans), age = getInsuranceAge();
  const maxCov = age ? getMaxCoverageByAge(prod, age) : prod.info.maxCoverage;
  const isUSD = prod.info.currency === 'USD';
  const dividendOptions = prod.info.dividendOptions || ['ç¹³æ¸…ä¿éšªé‡‘é¡'];
  
  let html = '<div class="max-w-3xl mx-auto"><button onclick="goStep(1)" class="text-blue-300 mb-4 no-print">â† è¿”å›</button>';
  
  // åŒ¯ç‡é¡¯ç¤ºï¼ˆç¾å…ƒå•†å“ï¼‰
  if (isUSD) {
    html += '<div class="glass rounded-xl p-3 mb-4 flex items-center gap-4 flex-wrap">';
    html += '<span class="text-sm text-blue-200">ğŸ’± åŒ¯ç‡ï¼š</span>';
    if (state.exchangeRateMode === 'fixed') {
      html += '<span class="text-white">å›ºå®š 1 USD = <input type="number" value="' + state.exchangeRate + '" onchange="setExchangeRate(this.value)" step="0.1" class="w-16 px-1 py-0.5 bg-white/10 border border-white/20 rounded text-white text-sm text-center"/> TWD</span>';
    } else {
      html += '<span class="text-white">é€å¹´åŒ¯ç‡</span>';
      html += '<button onclick="goStep(1)" class="text-xs text-blue-300 underline">ä¿®æ”¹è¨­å®š</button>';
    }
    html += '</div>';
  }
  
  html += '<div class="glass rounded-xl p-6">';
  html += '<h2 class="text-xl font-bold text-white mb-1">' + prod.info.name + '</h2>';
  html += '<p class="text-sm text-blue-300 mb-4">' + prod.code + (isUSD ? ' ğŸ’µ ç¾å…ƒè¨ˆåƒ¹' : ' ğŸ’´ å°å¹£è¨ˆåƒ¹') + '</p>';
  
  html += '<div class="mb-4"><label class="text-blue-200 text-sm">æ–¹æ¡ˆ</label><div class="grid grid-cols-' + Math.min(plans.length, 4) + ' gap-2 mt-1">';
  for (const [code, plan] of plans) {
    html += '<button onclick="selectPlan(\'' + code + '\')" class="p-2 rounded border ' + (state.selectedPlan?.code === code ? 'border-blue-400 bg-blue-500/20' : 'border-white/20') + '"><div class="text-white text-sm">' + plan.displayName + '</div><div class="text-xs text-blue-200">' + plan.minAge + '~' + plan.maxAge + 'æ­²</div></button>';
  }
  html += '</div></div>';
  
  html += '<div class="grid md:grid-cols-2 gap-4">';
  html += '<div><label class="text-blue-200 text-sm">å§“å</label><input type="text" value="' + state.form.name + '" onchange="updateForm(\'name\',this.value)" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white"/></div>';
  html += '<div><label class="text-blue-200 text-sm">æ€§åˆ¥</label><select onchange="updateForm(\'gender\',this.value)" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white"><option value="ç”·"' + (state.form.gender === 'ç”·' ? ' selected' : '') + '>ç”·</option><option value="å¥³"' + (state.form.gender === 'å¥³' ? ' selected' : '') + '>å¥³</option></select></div>';
  
  // å‡ºç”Ÿæ—¥æœŸï¼ˆå–®ä¸€æ¬„ä½ YYYMMDDï¼‰
  html += '<div><label class="text-blue-200 text-sm">å‡ºç”Ÿæ—¥æœŸï¼ˆæ°‘åœ‹ï¼‰</label>';
  html += '<input type="text" value="' + state.form.birthDate + '" onchange="updateForm(\'birthDate\',this.value)" placeholder="1040101" maxlength="7" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white"/>';
  html += (age ? '<p class="text-sm text-blue-300 mt-1">ä¿éšªå¹´é½¡ï¼š' + age + ' æ­²</p>' : '<p class="text-sm text-blue-300/50 mt-1">æ ¼å¼ï¼šYYYMMDDï¼ˆå¦‚ 0840101ï¼‰</p>') + '</div>';
  
  // ä¿é¡
  html += '<div><label class="text-blue-200 text-sm">ä¿é¡ï¼ˆè¬ ' + (isUSD ? 'USD' : 'TWD') + 'ï¼‰</label><input type="number" value="' + state.form.coverage + '" onchange="updateForm(\'coverage\',this.value)" step="0.1" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white"/>';
  html += '<p class="text-sm text-blue-300 mt-1">ç¯„åœï¼š' + prod.info.minCoverage + ' ~ ' + maxCov + ' è¬</p></div>';
  
  // ä¿è²»æ›ç®—ä¿é¡ï¼ˆçµ±ä¸€ç”¨å°å¹£è¼¸å…¥ï¼‰
  html += '<div class="md:col-span-2"><label class="text-blue-200 text-sm">ğŸ’¡ ä¿è²»æ›ç®—ä¿é¡</label>';
  html += '<div class="flex gap-2 mt-1">';
  html += '<div class="flex-1 relative"><input type="number" value="' + (state.form.targetPremiumTWD || '') + '" onchange="updateForm(\'targetPremiumTWD\',this.value)" placeholder="è¼¸å…¥ç›®æ¨™å¹´ç¹³ä¿è²»" class="w-full px-3 py-2 pr-16 bg-white/10 border border-white/20 rounded text-white"/><span class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-300 text-sm">TWD</span></div>';
  html += '<button onclick="calculateCoverageFromPremium()" class="px-4 py-2 bg-purple-500/50 border border-purple-400/50 rounded text-white text-sm hover:bg-purple-500/70 whitespace-nowrap">æ›ç®—ä¿é¡</button>';
  html += '</div>';
  if (isUSD) html += '<p class="text-sm text-purple-300/70 mt-1">å°‡è‡ªå‹•ä»¥åŒ¯ç‡ ' + state.exchangeRate + ' æ›ç®—ç¾å…ƒä¿é¡</p>';
  html += '</div>';
  
  // ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼ˆå¦‚æœæœ‰å¤šå€‹é¸é …ï¼‰
  if (dividendOptions.length > 1) {
    html += '<div><label class="text-blue-200 text-sm">ç´…åˆ©çµ¦ä»˜æ–¹å¼</label><select onchange="updateForm(\'dividendMethod\',this.value)" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white">';
    for (const opt of dividendOptions) {
      html += '<option value="' + opt + '"' + (state.form.dividendMethod === opt ? ' selected' : '') + '>' + opt + '</option>';
    }
    html += '</select></div>';
  }
  
  // åˆ†ç´…å‡è¨­é¸é …ï¼ˆå¾å•†å“è³‡è¨Šè®€å–ï¼Œé è¨­ç‚º é«˜/ä¸­/ä½ï¼‰
  const levelOptions = prod.info?.dividendLevelOptions || ['é«˜åˆ†ç´…', 'ä¸­åˆ†ç´…', 'ä½åˆ†ç´…'];
  const levelMapping = {'é«˜åˆ†ç´…': 'high', 'ä¸­åˆ†ç´…': 'medium', 'ä½åˆ†ç´…': 'low', 'æœ€å¯èƒ½ç´…åˆ©': 'medium', 'è¼ƒä½ç´…åˆ©': 'low', 'å¯èƒ½ç´…åˆ©é‡‘é¡ç‚º0': 'zero'};
  const reverseLevelMapping = {'high': 'é«˜åˆ†ç´…', 'medium': 'ä¸­åˆ†ç´…', 'low': 'ä½åˆ†ç´…', 'zero': 'å¯èƒ½ç´…åˆ©é‡‘é¡ç‚º0'};
  
  html += '<div><label class="text-blue-200 text-sm">åˆ†ç´…å‡è¨­</label><select onchange="updateForm(\'dividendLevel\',this.value)" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white">';
  for (const opt of levelOptions) {
    const val = levelMapping[opt] || 'medium';
    html += '<option value="' + val + '"' + (state.form.dividendLevel === val ? ' selected' : '') + '>' + opt + '</option>';
  }
  html += '</select></div>';
  
  html += '<div><label class="text-blue-200 text-sm">ç¹³è²»æ–¹å¼</label><select onchange="updateForm(\'paymentMethod\',this.value)" class="w-full mt-1 px-3 py-2 bg-white/10 border border-white/20 rounded text-white"><option value="é‡‘èæ©Ÿæ§‹è½‰å¸³">é‡‘èæ©Ÿæ§‹è½‰å¸³</option><option value="è‡ªè¡Œç¹³è²»">è‡ªè¡Œç¹³è²»</option></select></div>';
  html += '<div class="flex items-center"><input type="checkbox" ' + (state.form.employeeDiscount ? 'checked' : '') + ' onchange="updateForm(\'employeeDiscount\',this.checked)"/><span class="ml-2 text-blue-200 text-sm">å“¡å·¥æŠ˜æ‰£</span></div>';
  html += '</div>';
  
  // é¡¯ç¤ºç•¶å‰ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼ˆå¦‚æœåªæœ‰ä¸€å€‹é¸é …ï¼‰
  if (dividendOptions.length === 1) {
    html += '<p class="text-sm text-blue-300 mt-4">ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼š' + dividendOptions[0] + '</p>';
  }
  
  if (state.error) html += '<p class="text-red-300 mt-4">âš ï¸ ' + state.error + '</p>';
  html += '<button onclick="doCalculate()" class="w-full mt-6 py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">ç«‹å³è©¦ç®—</button>';
  html += '</div></div>';
  return html;
}

function renderStep3() {
  const r = state.result;
  const levelTextMap = {'high': 'é«˜åˆ†ç´…', 'medium': 'ä¸­åˆ†ç´…', 'low': 'ä½åˆ†ç´…', 'zero': 'å¯èƒ½ç´…åˆ©é‡‘é¡ç‚º0'};
  const levelText = levelTextMap[r.dividendLevel] || 'ä¸­åˆ†ç´…';
  const isUSD = r.currency === 'USD';
  const currLabel = isUSD ? 'USD' : 'TWD';
  const displayCurr = (isUSD && state.showTWD) ? 'TWD' : currLabel;
  const dividendMethodText = r.dividendMethod || 'ç¹³æ¸…ä¿éšªé‡‘é¡';
  
  // æ‰¾å‡ºå¯æ¸›é¡ç¹³æ¸…çš„å¹´åº¦ (PA > 0 çš„å¹´åº¦)
  const availableReduceYears = r.benefits.filter(b => b.paRate > 0).map(b => b.year);
  
  // è¨ˆç®—æ¸›é¡ç¹³æ¸…æ¯”ä¾‹
  let reduceRatio = 1;
  let reduceYear = state.reducedPaidUpYear;
  if (reduceYear > 0 && reduceYear <= availableReduceYears.length) {
    const paRate = r.benefits[reduceYear - 1].paRate;
    reduceRatio = paRate / 10000;
  } else {
    reduceYear = 0;
  }
  
  // è™•ç†é¡¯ç¤ºè³‡æ–™
  // æ¸›é¡ç¹³æ¸…åœ¨ã€Œå¹´åº¦æœ«ã€åŸ·è¡Œï¼Œæ•ˆæœå¾ã€Œä¸‹ä¸€å¹´åº¦ã€é–‹å§‹
  const data = r.benefits.slice(0, state.displayYears).map((row, idx) => {
    const year = row.year;
    // æ¸›é¡ç¹³æ¸…å¹´åº¦ç•¶å¹´ï¼šæ­£å¸¸é¡¯ç¤ºï¼ˆé‚„æ²’æ¸›é¡ï¼‰
    // æ¸›é¡ç¹³æ¸…å¹´åº¦çš„ä¸‹ä¸€å¹´èµ·ï¼šæ‰€æœ‰æ•¸å€¼ä¹˜ä»¥æ¯”ä¾‹
    if (reduceYear > 0 && year > reduceYear) {
      return {
        ...row,
        annualPremium: 0,  // æ¸›é¡ç¹³æ¸…å¾Œä¸å†ç¹³è²»
        cumPremium: r.benefits[reduceYear - 1].cumPremium,  // ç´¯è¨ˆä¿è²»åœåœ¨æ¸›é¡å¹´
        survival: Math.round(row.survival * reduceRatio),
        cumSurvival: Math.round(row.cumSurvival * reduceRatio),
        deathTotal: Math.round(row.deathTotal * reduceRatio),
        surrenderTotal: Math.round(row.surrenderTotal * reduceRatio),
        isReduced: true
      };
    }
    return { ...row, isReduced: false };
  });
  
  let html = '<div class="max-w-7xl mx-auto"><button onclick="goStep(2)" class="text-blue-300 mb-4 no-print">â† è¿”å›ä¿®æ”¹</button>';
  
  // åŒ¯ç‡è¨­å®šï¼ˆç¾å…ƒå•†å“ï¼‰
  if (isUSD) {
    html += '<div class="glass rounded-xl p-3 mb-4 no-print">';
    html += '<div class="flex items-center gap-4 flex-wrap">';
    html += '<span class="text-sm text-blue-200">ğŸ’± åŒ¯ç‡ï¼š</span>';
    
    if (state.exchangeRateMode === 'fixed') {
      html += '<span class="text-white text-sm">å›ºå®š 1 USD =</span>';
      html += '<input type="number" value="' + state.exchangeRate + '" onchange="setExchangeRate(this.value)" step="0.1" class="w-20 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-sm text-center"/> TWD';
    } else {
      html += '<span class="text-white text-sm">é€å¹´åŒ¯ç‡</span>';
      html += '<button onclick="goStep(1)" class="text-xs text-blue-300 underline ml-2">ä¿®æ”¹è¨­å®š</button>';
    }
    
    html += '<label class="flex items-center ml-4"><input type="checkbox" ' + (state.showTWD ? 'checked' : '') + ' onchange="toggleShowTWD(this.checked)"/><span class="ml-2 text-blue-200 text-sm">é¡¯ç¤ºå°å¹£æ›ç®—</span></label>';
    html += '</div>';
    
    // é€å¹´åŒ¯ç‡å¿«é€Ÿé è¦½
    if (state.exchangeRateMode === 'yearly' && state.showTWD) {
      html += '<div class="mt-2 text-xs text-white/50">åŒ¯ç‡ï¼š';
      for (let y = 1; y <= Math.min(10, state.displayYears); y++) {
        html += 'ç¬¬' + y + 'å¹´=' + getExchangeRate(y) + (y < 10 ? ', ' : '...');
      }
      html += '</div>';
    }
    html += '</div>';
  }
  
  // æ¸›é¡ç¹³æ¸…è¨­å®š
  if (availableReduceYears.length > 0) {
    html += '<div class="glass rounded-xl p-3 mb-4 no-print">';
    html += '<div class="flex items-center gap-4 flex-wrap">';
    html += '<span class="text-sm text-purple-300">ğŸ“‹ æ¸›é¡ç¹³æ¸…è©¦ç®—ï¼š</span>';
    html += '<select onchange="setReducedPaidUpYear(this.value)" class="px-3 py-1 bg-white/10 border border-white/20 rounded text-white text-sm">';
    html += '<option value="0"' + (reduceYear === 0 ? ' selected' : '') + '>ä¸ä½¿ç”¨æ¸›é¡ç¹³æ¸…</option>';
    for (const y of availableReduceYears) {
      const pa = r.benefits[y - 1].paRate;
      const ratio = (pa / 100).toFixed(2);
      html += '<option value="' + y + '"' + (reduceYear === y ? ' selected' : '') + '>ç¬¬ ' + y + ' å¹´æœ«æ¸›é¡ï¼ˆ' + ratio + '%ï¼‰</option>';
    }
    html += '</select>';
    if (reduceYear > 0) {
      const reducedAmount = r.benefits[reduceYear - 1].reducedPaidUpAmount;
      html += '<span class="text-purple-200 text-sm">æ¸›é¡ç¹³æ¸…ä¿é¡ï¼š<strong class="text-purple-300">' + formatCurrency(reducedAmount, r.currency) + '</strong></span>';
    }
    html += '</div></div>';
  }
  
  // ğŸ†• éƒ¨åˆ†è§£ç´„è¨­å®š
  html += '<div class="glass rounded-xl p-3 mb-4 no-print">';
  html += '<div class="flex items-center gap-4 flex-wrap mb-2">';
  html += '<label class="flex items-center"><input type="checkbox" ' + (state.partialSurrenderMode ? 'checked' : '') + ' onchange="togglePartialSurrenderMode(this.checked)"/><span class="ml-2 text-orange-300 text-sm font-semibold">ğŸ’¸ éƒ¨åˆ†è§£ç´„è©¦ç®—</span></label>';
  if (state.partialSurrenderMode) {
    html += '<button onclick="addPartialSurrender()" class="px-2 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600">+ æ–°å¢å€é–“</button>';
  }
  html += '</div>';
  
  if (state.partialSurrenderMode) {
    const rate = state.exchangeRate;
    if (state.partialSurrenders.length === 0) {
      html += '<p class="text-white/50 text-sm">å°šæœªè¨­å®šéƒ¨åˆ†è§£ç´„ï¼Œé»æ“Šã€Œæ–°å¢å€é–“ã€é–‹å§‹è¨­å®š</p>';
    } else {
      html += '<div class="space-y-2">';
      for (let i = 0; i < state.partialSurrenders.length; i++) {
        const s = state.partialSurrenders[i];
        const fromAge = r.age + s.fromYear - 1;
        const toAge = r.age + s.toYear - 1;
        html += '<div class="flex items-center gap-2 p-2 bg-orange-500/10 rounded flex-wrap">';
        html += '<span class="text-white text-sm">ç¬¬</span>';
        html += '<input type="number" value="' + s.fromYear + '" onchange="updatePartialSurrender(' + i + ',\'fromYear\',this.value)" min="1" max="75" class="w-14 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center text-sm"/>';
        html += '<span class="text-white text-sm">~</span>';
        html += '<input type="number" value="' + s.toYear + '" onchange="updatePartialSurrender(' + i + ',\'toYear\',this.value)" min="1" max="75" class="w-14 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center text-sm"/>';
        html += '<span class="text-white text-sm">å¹´</span>';
        html += '<span class="text-white/50 text-xs">(' + fromAge + '~' + toAge + 'æ­²)</span>';
        html += '<span class="text-white text-sm">æ¯å¹´è§£ç´„</span>';
        html += '<input type="number" value="' + s.amountPerYear + '" onchange="updatePartialSurrender(' + i + ',\'amountPerYear\',this.value)" min="1" class="w-20 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center text-sm"/>';
        // âœ… v7.4: æé ˜å–®ä½å›ºå®šç‚ºã€Œè¬ TWDã€ï¼ˆå·¥å» çš„é‚è¼¯ï¼‰
        html += '<span class="text-white text-sm">è¬TWD</span>';
        html += '<button onclick="removePartialSurrender(' + i + ')" class="px-2 py-1 bg-red-500/50 text-white rounded text-xs hover:bg-red-500">âœ•</button>';
        // è¨ˆç®—å°è¨ˆ
        const totalYears = Math.max(0, s.toYear - s.fromYear + 1);
        const totalAmount = totalYears * s.amountPerYear;
        // âœ… v7.4: å›ºå®šé¡¯ç¤º TWDï¼Œä¸¦æ›ç®— USDï¼ˆå¦‚æœæ˜¯ USD å•†å“ï¼‰
        html += '<span class="text-orange-300 text-xs ml-2">= ' + totalYears + 'å¹´ Ã— ' + s.amountPerYear + 'è¬ = ' + totalAmount + 'è¬ TWD';
        if (isUSD) {
          const amountUSD = (s.amountPerYear / rate).toFixed(2);
          const totalUSD = (totalAmount / rate).toFixed(2);
          html += ' â‰ˆ ' + totalUSD + 'è¬ USD';
        }
        html += '</span>';
        html += '</div>';
      }
      html += '</div>';
    }
  }
  html += '</div>';
  
  html += '<div class="grid grid-cols-2 md:grid-cols-7 gap-3 mb-4">';
  
  // è¢«ä¿éšªäººå¡ç‰‡ï¼ˆæ€§åˆ¥å¯é¸ã€å‡ºç”Ÿæ—¥æœŸå¯ç·¨è¼¯ï¼‰
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">è¢«ä¿éšªäºº</p>';
  html += '<p class="font-bold text-white">' + r.name + '</p>';
  html += '<div class="flex items-center gap-1 mt-1">';
  html += '<select onchange="quickUpdate(\'gender\',this.value)" class="text-xs bg-white/10 border border-white/20 rounded px-1 py-0.5 text-white">';
  html += '<option value="ç”·"' + (r.gender === 'ç”·' ? ' selected' : '') + '>ç”·</option>';
  html += '<option value="å¥³"' + (r.gender === 'å¥³' ? ' selected' : '') + '>å¥³</option>';
  html += '</select>';
  html += '<span class="text-xs text-white/50">ãƒ»</span>';
  html += '<span class="text-xs text-blue-300">' + r.age + 'æ­²</span>';
  html += '</div>';
  html += '<input type="text" value="' + state.form.birthDate + '" onchange="quickUpdate(\'birthDate\',this.value)" class="w-full mt-1 text-xs bg-white/10 border border-white/20 rounded px-1 py-0.5 text-white text-center" maxlength="7" placeholder="YYYMMDD"/>';
  html += '</div>';
  
  // éšªç¨®å¡ç‰‡ï¼ˆä¸å¯ç·¨è¼¯ï¼‰
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">éšªç¨®</p><p class="font-bold text-white">' + r.plan.displayName + '</p></div>';
  
  // ä¿é¡å¡ç‰‡ï¼ˆå¯ç·¨è¼¯ï¼‰
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">ä¿é¡</p>';
  html += '<div class="flex items-center gap-1">';
  html += '<input type="number" value="' + r.coverage + '" onchange="quickUpdate(\'coverage\',this.value)" step="0.1" class="w-16 font-bold bg-white/10 border border-white/20 rounded px-2 py-0.5 text-white"/>';
  html += '<span class="text-white text-sm">è¬ ' + currLabel + '</span>';
  html += '</div></div>';
  
  // å¹´ç¹³ä¿è²»ï¼ˆä¸å¯ç·¨è¼¯ï¼‰
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">å¹´ç¹³ä¿è²»</p><p class="font-bold text-white">' + formatCurrency(r.basePremium, r.currency) + ' ' + displayCurr + '</p></div>';
  
  // å„ªæƒ å¾Œä¿è²»ï¼ˆä¸å¯ç·¨è¼¯ï¼‰
  html += '<div class="glass rounded-xl p-3 bg-green-500/20"><p class="text-xs text-blue-200">å„ªæƒ å¾Œä¿è²»</p><p class="font-bold text-green-300">' + formatCurrency(r.actualPremium, r.currency) + ' ' + displayCurr + '</p><p class="text-xs text-white/50">æŠ˜æ‰£ ' + r.discountRate.toFixed(1) + '%</p></div>';
  
  // åˆ†ç´…å‡è¨­å¡ç‰‡ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰
  const levelOptions = r.product.info?.dividendLevelOptions || ['é«˜åˆ†ç´…', 'ä¸­åˆ†ç´…', 'ä½åˆ†ç´…'];
  const levelMapping = {'é«˜åˆ†ç´…': 'high', 'ä¸­åˆ†ç´…': 'medium', 'ä½åˆ†ç´…': 'low', 'å¯èƒ½ç´…åˆ©é‡‘é¡ç‚º0': 'zero'};
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">åˆ†ç´…å‡è¨­</p>';
  html += '<select onchange="quickUpdate(\'dividendLevel\',this.value)" class="w-full mt-1 font-bold bg-white/10 border border-white/20 rounded px-2 py-1 text-white text-sm">';
  for (const opt of levelOptions) {
    const val = levelMapping[opt] || 'medium';
    html += '<option value="' + val + '"' + (r.dividendLevel === val ? ' selected' : '') + '>' + opt + '</option>';
  }
  html += '</select></div>';
  
  // ç´…åˆ©çµ¦ä»˜å¡ç‰‡ï¼ˆè‹¥æœ‰å¤šé¸é …å‰‡ä¸‹æ‹‰é¸å–®ï¼‰
  const dividendOpts = r.product.info?.dividendOptions || [dividendMethodText];
  html += '<div class="glass rounded-xl p-3"><p class="text-xs text-blue-200">ç´…åˆ©çµ¦ä»˜</p>';
  if (dividendOpts.length > 1) {
    html += '<select onchange="quickUpdate(\'dividendMethod\',this.value)" class="w-full mt-1 font-bold bg-white/10 border border-white/20 rounded px-2 py-1 text-yellow-300 text-sm">';
    for (const opt of dividendOpts) {
      html += '<option value="' + opt + '"' + (r.dividendMethod === opt ? ' selected' : '') + '>' + opt + '</option>';
    }
    html += '</select>';
  } else {
    html += '<p class="font-bold text-yellow-300 text-sm mt-1">' + dividendMethodText + '</p>';
  }
  html += '</div>';
  
  html += '</div>';
  
  html += '<div class="glass rounded-xl p-3 mb-4 no-print"><span class="text-sm text-blue-200">é¡¯ç¤ºå¹´æ•¸ï¼š</span><select onchange="setDisplayYears(this.value)" class="ml-2 px-3 py-1 bg-white/10 border border-white/20 rounded text-white text-sm">';
  [10, 20, 30, 50, 75].forEach(n => { html += '<option value="' + n + '"' + (state.displayYears === n ? ' selected' : '') + '>å‰' + n + 'å¹´</option>'; });
  html += '</select></div>';
  
  // æ ¹æ“šæ˜¯å¦å•Ÿç”¨éƒ¨åˆ†è§£ç´„é¸æ“‡ä¸åŒè¡¨æ ¼
  if (state.partialSurrenderMode && state.partialSurrenders.length > 0 && reduceYear === 0) {
    html += renderPartialSurrenderTable(r, data, isUSD, levelText, dividendMethodText);
  } else {
    const tableTitle = reduceYear > 0 ? 'æ¸›é¡ç¹³æ¸…è©¦ç®—è¡¨ï¼ˆç¬¬ ' + reduceYear + ' å¹´æœ«æ¸›é¡ï¼Œç¬¬ ' + (reduceYear + 1) + ' å¹´èµ·æŒ‰ ' + (reduceRatio * 100).toFixed(2) + '% è¨ˆç®—ï¼‰' : 'åˆ†ç´…ä¿å–®æŠ•ä¿åˆ©ç›Šå½™ç¸½è¡¨';
    
    let rateNote = '';
    if (isUSD && state.showTWD) {
      rateNote = state.exchangeRateMode === 'fixed' 
        ? 'ï¼ˆå°å¹£æ›ç®—ï¼Œå›ºå®šåŒ¯ç‡ ' + state.exchangeRate + 'ï¼‰' 
        : 'ï¼ˆå°å¹£æ›ç®—ï¼Œé€å¹´åŒ¯ç‡ï¼‰';
    }
    
    html += '<div class="glass rounded-xl overflow-hidden"><div class="p-4 border-b border-white/10"><h3 class="font-bold text-white">' + tableTitle + '</h3><p class="text-sm text-blue-200">å‡è¨­åˆ†ç´…ï¼š' + levelText + 'ï¼›ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼š' + dividendMethodText + rateNote + '</p></div>';
    html += '<div class="table-scroll"><table class="w-full text-sm"><thead class="sticky-header"><tr>';
    html += '<th class="px-2 py-2 text-left text-blue-200">å¹´åº¦</th>';
    html += '<th class="px-2 py-2 text-left text-blue-200">å¹´é½¡</th>';
    html += '<th class="px-2 py-2 text-right text-blue-200">å¹´ç¹³ä¿è²»</th>';
    html += '<th class="px-2 py-2 text-right text-blue-200">ç´¯è¨ˆä¿è²»</th>';
    if (reduceYear === 0) html += '<th class="px-2 py-2 text-right text-purple-300">æ¸›é¡ç¹³æ¸…</th>';
    html += '<th class="px-2 py-2 text-right text-yellow-300">ç”Ÿå­˜é‡‘</th>';
    html += '<th class="px-2 py-2 text-right text-yellow-300">ç´¯è¨ˆç”Ÿå­˜</th>';
    html += '<th class="px-2 py-2 text-right text-green-300">èº«æ•…ç¸½é¡</th>';
    html += '<th class="px-2 py-2 text-right text-blue-300">è§£ç´„ç¸½é¡</th>';
    html += '</tr></thead><tbody>';
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i], isPayYear = row.annualPremium > 0, hasSurv = row.survival > 0;
      const isReducePoint = reduceYear > 0 && row.year === reduceYear;
      const isYear5n = row.year % 5 === 0;
      let rowClass = isYear5n ? 'year-5n' : (i % 2 ? 'bg-white/5' : '');
      if (isPayYear) rowClass += ' font-semibold';
      if (hasSurv && !isYear5n) rowClass += ' bg-green-500/10';
      if (isReducePoint) rowClass = 'bg-purple-500/20 font-bold';
      else if (row.isReduced && !isYear5n) rowClass += ' bg-purple-500/5';
      
      html += '<tr class="' + rowClass + '">';
      html += '<td class="px-2 py-1.5 text-white">' + row.year + (isReducePoint ? ' ğŸ“‹' : '') + '</td>';
      html += '<td class="px-2 py-1.5 text-white">' + (r.age + row.year - 1) + '</td>';
      html += '<td class="px-2 py-1.5 text-right text-white">' + (row.annualPremium ? formatCurrency(row.annualPremium, r.currency, row.year) : '') + '</td>';
      html += '<td class="px-2 py-1.5 text-right text-white">' + formatCurrency(row.cumPremium, r.currency, row.year) + '</td>';
      if (reduceYear === 0) {
        const hasPA = row.paRate > 0;
        html += '<td class="px-2 py-1.5 text-right ' + (hasPA ? 'text-purple-300' : 'text-white/30') + '">' + (hasPA ? formatCurrency(row.reducedPaidUpAmount, r.currency, row.year) : '-') + '</td>';
      }
      html += '<td class="px-2 py-1.5 text-right text-yellow-300">' + (row.survival ? formatCurrency(row.survival, r.currency, row.year) : '') + '</td>';
      html += '<td class="px-2 py-1.5 text-right text-yellow-300">' + (row.cumSurvival ? formatCurrency(row.cumSurvival, r.currency, row.year) : '') + '</td>';
      html += '<td class="px-2 py-1.5 text-right text-green-300">' + formatCurrency(row.deathTotal, r.currency, row.year) + '</td>';
      html += '<td class="px-2 py-1.5 text-right text-blue-300">' + formatCurrency(row.surrenderTotal, r.currency, row.year) + '</td>';
      html += '</tr>';
    }
    html += '</tbody></table></div></div>';
    
    // èªªæ˜
    if (reduceYear === 0) {
      html += '<div class="glass rounded-xl p-4 mt-4 text-sm">';
      html += '<p class="text-purple-300 font-semibold mb-2">ğŸ’¡ æ¸›é¡ç¹³æ¸…èªªæ˜</p>';
      html += '<p class="text-blue-200">æ¸›é¡ç¹³æ¸…ä¿é¡æ¬„ä½é¡¯ç¤ºåœ¨å„å¹´åº¦æœ«å¯åŸ·è¡Œæ¸›é¡ç¹³æ¸…æ™‚çš„ä¿é¡ã€‚</p>';
      html += '<p class="text-white/60 mt-1">é¸æ“‡ã€Œæ¸›é¡ç¹³æ¸…è©¦ç®—ã€å¾Œï¼Œå¯æŸ¥çœ‹æ¸›é¡ç¹³æ¸…å¾Œå„å¹´åº¦çš„é ä¼°æ•¸å€¼ã€‚</p>';
      html += '</div>';
    } else {
      html += '<div class="glass rounded-xl p-4 mt-4 text-sm bg-purple-500/10">';
      html += '<p class="text-purple-300 font-semibold mb-2">ğŸ“‹ æ¸›é¡ç¹³æ¸…è©¦ç®—èªªæ˜</p>';
      html += '<p class="text-blue-200">ç¬¬ ' + reduceYear + ' å¹´æœ«åŸ·è¡Œæ¸›é¡ç¹³æ¸…ï¼š</p>';
      html += '<ul class="text-white/70 mt-1 list-disc list-inside">';
      html += '<li>ç¬¬ ' + reduceYear + ' å¹´æ­£å¸¸ç¹³è²»ã€æ­£å¸¸çµ¦ä»˜</li>';
      html += '<li>ç¬¬ ' + (reduceYear + 1) + ' å¹´èµ·ä¸å†ç¹³è²»</li>';
      html += '<li>ç¬¬ ' + (reduceYear + 1) + ' å¹´èµ·çš„ç”Ÿå­˜é‡‘ã€èº«æ•…ã€è§£ç´„é‡‘çš†æŒ‰ <strong class="text-purple-300">' + (reduceRatio * 100).toFixed(2) + '%</strong> æ¯”ä¾‹è¨ˆç®—</li>';
      html += '</ul>';
      html += '</div>';
    }
  }
  
  // ç´…åˆ©çµ¦ä»˜æ–¹å¼èªªæ˜
  if (dividendMethodText !== 'ç¹³æ¸…ä¿éšªé‡‘é¡') {
    html += '<div class="glass rounded-xl p-4 mt-4 text-sm bg-yellow-500/10">';
    html += '<p class="text-yellow-300 font-semibold mb-2">âš ï¸ ç´…åˆ©çµ¦ä»˜æ–¹å¼èªªæ˜</p>';
    html += '<p class="text-blue-200">æ‚¨é¸æ“‡çš„ç´…åˆ©çµ¦ä»˜æ–¹å¼ç‚ºã€Œ' + dividendMethodText + 'ã€ã€‚</p>';
    if (dividendMethodText === 'ç¾é‡‘çµ¦ä»˜') {
      html += '<p class="text-white/60 mt-1">ç¾é‡‘çµ¦ä»˜æ¨¡å¼ä¸‹ï¼Œå¹´åº¦ç´…åˆ©æœƒåŠ å…¥ç”Ÿå­˜é‡‘æ¬„ä½ä¸€èµ·é¡¯ç¤ºã€‚ç›®å‰è¨ˆç®—å¼•æ“ä»¥ã€Œç¹³æ¸…ä¿éšªé‡‘é¡ã€ç‚ºåŸºç¤ï¼Œå¯¦éš›æ•¸å€¼è«‹ä»¥å…¬ç‰ˆè©¦ç®—è¡¨ç‚ºæº–ã€‚</p>';
    } else if (dividendMethodText === 'å„²å­˜ç”Ÿæ¯') {
      html += '<p class="text-white/60 mt-1">å„²å­˜ç”Ÿæ¯æ¨¡å¼ä¸‹ï¼Œç´…åˆ©æœƒç´¯ç©ç”Ÿæ¯ã€‚ç›®å‰è¨ˆç®—å¼•æ“ä»¥ã€Œç¹³æ¸…ä¿éšªé‡‘é¡ã€ç‚ºåŸºç¤ï¼Œå¯¦éš›æ•¸å€¼è«‹ä»¥å…¬ç‰ˆè©¦ç®—è¡¨ç‚ºæº–ã€‚</p>';
    } else {
      html += '<p class="text-white/60 mt-1">ç›®å‰è¨ˆç®—å¼•æ“ä»¥ã€Œç¹³æ¸…ä¿éšªé‡‘é¡ã€ç‚ºåŸºç¤è¨ˆç®—ï¼Œå¯¦éš›æ•¸å€¼è«‹ä»¥å…¬ç‰ˆè©¦ç®—è¡¨ç‚ºæº–ã€‚</p>';
    }
    html += '</div>';
  }
  
  html += '<div class="flex justify-center gap-4 mt-6 no-print"><button onclick="goStep(1)" class="px-6 py-3 border-2 border-blue-400 text-blue-300 rounded-xl">é‡æ–°è©¦ç®—</button><button onclick="openDMDesigner()" class="px-6 py-3 bg-amber-500 text-white rounded-xl font-bold">ğŸ“„ ç”Ÿæˆ DM</button><button onclick="window.print()" class="px-6 py-3 bg-blue-500 text-white rounded-xl">åˆ—å°</button></div>';
  html += '</div>';
  return html;
}

function selectProduct(code) { 
  state.selectedProduct = state.products[code]; 
  const plans = Object.entries(state.selectedProduct.plans); 
  state.selectedPlan = { code: plans[0][0], ...plans[0][1] }; 
  state.error = null; 
  state.step = 2; 
  state.reducedPaidUpYear = 0;
  // è¨­å®šé è¨­ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼ˆç¬¬ä¸€å€‹é¸é …ï¼‰
  const dividendOptions = state.selectedProduct.info?.dividendOptions || ['ç¹³æ¸…ä¿éšªé‡‘é¡'];
  state.form.dividendMethod = dividendOptions[0];
  loadRates(code); 
}
function selectPlan(code) { state.selectedPlan = { code, ...state.selectedProduct.plans[code] }; state.error = null; render(); }
function updateForm(key, value) { state.form[key] = value; state.error = null; render(); }
function goStep(n) { state.step = n; state.error = null; if (n !== 3) state.reducedPaidUpYear = 0; render(); }
function setDisplayYears(n) { state.displayYears = parseInt(n); render(); }
function setExchangeRate(v) { state.exchangeRate = parseFloat(v) || 32.5; render(); }
function toggleShowTWD(v) { state.showTWD = v; render(); }
function setReducedPaidUpYear(y) { state.reducedPaidUpYear = parseInt(y) || 0; render(); }

// ğŸ†• v7.28: æ‰“é–‹ DM Designer
function openDMDesigner() {
  const r = state.result;
  if (!r) return;
  
  const params = new URLSearchParams();
  params.set('product', state.selectedProduct.code);
  params.set('plan', state.selectedPlan.code);
  params.set('age', r.age);
  params.set('gender', r.gender === 'ç”·' ? 'male' : 'female');
  params.set('coverage', r.coverage);
  params.set('queryAge', r.age + 30); // é è¨­æŸ¥è©¢ 30 å¹´å¾Œ
  
  window.open('dm-designer.html?' + params.toString(), '_blank');
}

// ğŸ†• éƒ¨åˆ†è§£ç´„è¡¨æ ¼æ¸²æŸ“
function renderPartialSurrenderTable(r, originalData, isUSD, levelText, dividendMethodText) {
  // âœ… v7.2: benefits å·²ç¶“åŒ…å«éƒ¨åˆ†æé ˜è™•ç†éçš„æ•¸æ“šï¼Œç›´æ¥ä½¿ç”¨
  // ä¸å†éœ€è¦èª¿ç”¨ calculateWithPartialSurrender
  const data = originalData.slice(0, state.displayYears);
  const rate = state.exchangeRate;
  
  let rateNote = '';
  if (isUSD && state.showTWD) {
    rateNote = state.exchangeRateMode === 'fixed' 
      ? 'ï¼ˆå°å¹£æ›ç®—ï¼Œå›ºå®šåŒ¯ç‡ ' + state.exchangeRate + 'ï¼‰' 
      : 'ï¼ˆå°å¹£æ›ç®—ï¼Œé€å¹´åŒ¯ç‡ï¼‰';
  }
  
  // çµ±è¨ˆï¼ˆä½¿ç”¨ TWD æé ˜é‡‘é¡ï¼‰
  let totalSurrenderValueTWD = 0;
  for (const row of originalData) {
    totalSurrenderValueTWD += row.partialSurrenderTWD || 0;
  }
  
  let html = '<div class="glass rounded-xl overflow-hidden">';
  html += '<div class="p-4 border-b border-white/10">';
  html += '<h3 class="font-bold text-orange-300">ğŸ’¸ éƒ¨åˆ†è§£ç´„è©¦ç®—è¡¨ <span class="text-xs text-white/50">v7.19</span></h3>';
  html += '<p class="text-sm text-blue-200">å‡è¨­åˆ†ç´…ï¼š' + levelText + 'ï¼›ç´…åˆ©çµ¦ä»˜æ–¹å¼ï¼š' + dividendMethodText + rateNote + '</p>';
  html += '<p class="text-sm text-white/50">ä¿é¡ï¼š' + r.coverage.toFixed(2) + ' è¬ ' + r.currency + 'ï¼ˆæé ˜å–®ä½ï¼šè¬ TWDï¼‰</p>';
  
  // è§£ç´„æ‘˜è¦
  html += '<div class="mt-2 p-2 bg-orange-500/10 rounded text-sm">';
  html += '<span class="text-orange-300">è¨­å®šï¼š</span>';
  for (const s of state.partialSurrenders) {
    const fromAge = r.age + s.fromYear - 1;
    const toAge = r.age + s.toYear - 1;
    html += '<span class="text-white/70 ml-2">ç¬¬' + s.fromYear + '~' + s.toYear + 'å¹´ï¼ˆ' + fromAge + '~' + toAge + 'æ­²ï¼‰æ¯å¹´ ' + s.amountPerYear + ' è¬TWD';
    if (isUSD) {
      const amountUSD = (s.amountPerYear * 10000 / rate).toFixed(0);
      html += ' â‰ˆ ' + amountUSD + ' USD';
    }
    html += '</span>';
  }
  html += '</div>';
  html += '<div class="mt-1 p-2 bg-orange-500/10 rounded text-sm">';
  // âœ… v7.7: é¡¯ç¤º TWD å’ŒåŸå¹£å…©ç¨®ç´¯è¨ˆ
  html += '<span class="text-orange-300">ç´¯è¨ˆæé ˜ï¼š' + totalSurrenderValueTWD.toLocaleString() + ' TWD';
  if (isUSD) {
    html += ' â‰ˆ ' + Math.round(totalSurrenderValueTWD / rate).toLocaleString() + ' USD';
  }
  html += '</span>';
  html += '</div>';
  html += '</div>';
  
  html += '<div class="table-scroll"><table class="w-full text-sm">';
  html += '<thead class="sticky-header"><tr>';
  html += '<th class="px-2 py-2 text-left text-blue-200">å¹´åº¦</th>';
  html += '<th class="px-2 py-2 text-left text-blue-200">å¹´é½¡</th>';
  html += '<th class="px-2 py-2 text-right text-blue-200">å¹´ç¹³ä¿è²»</th>';
  html += '<th class="px-2 py-2 text-right text-orange-300">æé ˜(TWD)</th>';
  html += '<th class="px-2 py-2 text-right text-orange-200">ç´¯è¨ˆ(TWD)</th>';
  html += '<th class="px-2 py-2 text-right text-yellow-300">ç”Ÿå­˜é‡‘</th>';
  html += '<th class="px-2 py-2 text-right text-yellow-300">ç´¯è¨ˆé ˜å–</th>';
  html += '<th class="px-2 py-2 text-right text-green-300">èº«æ•…ç¸½é¡</th>';
  html += '<th class="px-2 py-2 text-right text-blue-300">è§£ç´„ç¸½é¡</th>';
  html += '<th class="px-2 py-2 text-right text-purple-300">N(ç´¯è¨ˆ)</th>';
  html += '<th class="px-2 py-2 text-right text-red-300">ç•¶å¹´ç¸®æ¸›</th>';
  html += '<th class="px-2 py-2 text-right text-pink-300">ç´¯è¨ˆå› å­</th>';
  html += '</tr></thead><tbody>';
  
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const hasSurrender = row.hasPartialSurrender;
    const isYear5n = row.year % 5 === 0;
    
    let rowClass = hasSurrender ? 'partial-surrender-row' : (isYear5n ? 'year-5n' : (i % 2 ? 'bg-white/5' : ''));
    if (row.annualPremium > 0) rowClass += ' font-semibold';
    
    // ç´¯è¨ˆé ˜å– = ç´¯è¨ˆç”Ÿå­˜é‡‘ + ç´¯è¨ˆéƒ¨ä»½æé ˜(åŸå¹£)
    const cumReceived = (row.cumSurvival || 0) + (row.cumPartialSurrender || 0);
    
    html += '<tr class="' + rowClass + '">';
    html += '<td class="px-2 py-1.5 text-white">' + row.year + (hasSurrender ? ' ğŸ’¸' : '') + '</td>';
    html += '<td class="px-2 py-1.5 text-white">' + (r.age + row.year - 1) + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-white">' + (row.annualPremium > 0 ? formatCurrency(row.annualPremium, r.currency, row.year) : '') + '</td>';
    // v7.8: TWD æé ˜é‡‘é¡
    html += '<td class="px-2 py-1.5 text-right text-orange-300 font-bold">' + (row.partialSurrenderTWD > 0 ? row.partialSurrenderTWD.toLocaleString() : '') + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-orange-200">' + (row.cumPartialSurrenderTWD > 0 ? row.cumPartialSurrenderTWD.toLocaleString() : '') + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-yellow-300">' + (row.survival > 0 ? formatCurrency(row.survival, r.currency, row.year) : '') + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-yellow-300">' + formatCurrency(cumReceived, r.currency, row.year) + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-green-300">' + formatCurrency(row.deathTotal, r.currency, row.year) + '</td>';
    html += '<td class="px-2 py-1.5 text-right text-blue-300">' + formatCurrency(row.surrenderTotal, r.currency, row.year) + '</td>';
    // v7.8: Nï¼ˆç´¯è¨ˆç¹³æ¸…ä¿é¡ï¼‰
    html += '<td class="px-2 py-1.5 text-right text-purple-300 text-xs">' + (row.cumPaidUp || 0).toLocaleString() + '</td>';
    // v7.8: ç•¶å¹´ç¸®æ¸›æ¯”ä¾‹
    html += '<td class="px-2 py-1.5 text-right text-red-300 text-xs">' + (row.reductionRatio > 0 ? (row.reductionRatio * 100).toFixed(2) + '%' : '') + '</td>';
    // v7.8: ç´¯è¨ˆç¸®æ¸›å› å­
    html += '<td class="px-2 py-1.5 text-right text-pink-300 text-xs">' + (row.cumulativeReductionFactor < 1 ? (row.cumulativeReductionFactor * 100).toFixed(2) + '%' : '') + '</td>';
    html += '</tr>';
  }
  
  html += '</tbody></table></div></div>';
  
  // âœ… v7.19 è¨ºæ–·è¡¨æ ¼
  html += '<div class="glass rounded-xl overflow-hidden mt-4">';
  html += '<div class="p-4 border-b border-white/10">';
  html += '<h3 class="font-bold text-red-400">ğŸ” è¨ºæ–·è¡¨ï¼ˆç¬¬9-13å¹´ä¸­é–“å€¼ï¼‰<span class="text-xs text-white/50">v7.19</span></h3>';
  html += '<p class="text-xs text-white/50">å°æ¯”å·¥å» æ•¸æ“šæ‰¾å‡ºå·®ç•°ä¾†æº</p>';
  html += '</div>';
  html += '<div class="table-scroll"><table class="w-full text-xs">';
  html += '<thead class="sticky-header"><tr>';
  html += '<th class="px-1 py-1 text-left text-blue-200">å¹´</th>';
  html += '<th class="px-1 py-1 text-right text-yellow-300">K(ç´…åˆ©)</th>';
  html += '<th class="px-1 py-1 text-right text-purple-300">prevN</th>';
  html += '<th class="px-1 py-1 text-right text-purple-300">curN</th>';
  html += '<th class="px-1 py-1 text-right text-green-300">deathA</th>';
  html += '<th class="px-1 py-1 text-right text-green-300">deathD</th>';
  html += '<th class="px-1 py-1 text-right text-green-300">deathX</th>';
  html += '<th class="px-1 py-1 text-right text-green-400">ç„¡æé ˜æ­»(USD)</th>';
  html += '<th class="px-1 py-1 text-right text-blue-300">surrB</th>';
  html += '<th class="px-1 py-1 text-right text-blue-300">surrE</th>';
  html += '<th class="px-1 py-1 text-right text-blue-300">surrY</th>';
  html += '<th class="px-1 py-1 text-right text-blue-400">ç„¡æé ˜è§£(USD)</th>';
  html += '<th class="px-1 py-1 text-right text-orange-300">ç„¡æé ˜è§£(TWD)</th>';
  html += '<th class="px-1 py-1 text-right text-red-300">ç¸®æ¸›%</th>';
  html += '<th class="px-1 py-1 text-right text-pink-300">ç´¯è¨ˆå› å­</th>';
  html += '</tr></thead><tbody>';
  
  // åªé¡¯ç¤ºç¬¬9-20å¹´
  for (let i = 8; i < Math.min(20, data.length); i++) {
    const row = data[i];
    const d = row._debug || {};
    const hasSurrender = row.hasPartialSurrender;
    let rowClass = hasSurrender ? 'bg-orange-500/20' : (i % 2 ? 'bg-white/5' : '');
    
    html += '<tr class="' + rowClass + '">';
    html += '<td class="px-1 py-1 text-white font-bold">' + row.year + '</td>';
    html += '<td class="px-1 py-1 text-right text-yellow-300">' + (d.annualDividendK || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-purple-300">' + (d.prevReducedCumPaidUp || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-purple-300">' + (d.beforeReductionCumPaidUp || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-green-300">' + (d.deathA || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-green-300">' + (d.deathD || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-green-300">' + (d.deathX || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-green-400 font-bold">' + (d.deathNoWithdraw || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-blue-300">' + (d.surrenderB || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-blue-300">' + (d.surrenderE || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-blue-300">' + (d.surrenderY || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-blue-400 font-bold">' + (d.surrenderNoWithdraw || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-orange-300 font-bold">' + (d.surrenderNoWithdrawTWD || 0).toLocaleString() + '</td>';
    html += '<td class="px-1 py-1 text-right text-red-300">' + (row.reductionRatio > 0 ? (row.reductionRatio * 100).toFixed(4) + '%' : '') + '</td>';
    html += '<td class="px-1 py-1 text-right text-pink-300">' + (row.cumulativeReductionFactor < 1 ? (row.cumulativeReductionFactor * 100).toFixed(4) + '%' : '100%') + '</td>';
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  
  // å·¥å» æ•¸æ“šåƒè€ƒ
  html += '<div class="p-2 bg-blue-500/10 text-xs">';
  html += '<p class="text-blue-300 font-bold mb-1">ğŸ“Š å·¥å» åƒè€ƒæ•¸æ“šï¼š</p>';
  html += '<p class="text-white/70">ç¬¬9å¹´ï¼šè§£ç´„=958,104 | Qt=56,012 | Q=50,000</p>';
  html += '<p class="text-white/70">ç¬¬10å¹´ï¼šè§£ç´„=937,314 | Qt=54,129 | Q=47,391</p>';
  html += '<p class="text-yellow-300 mt-1">v7.19ï¼šç­‰æ¯”ä¾‹åˆ‡å‰²æ³• - K=ä¿ç•™æ¯”ä¾‹=1-Rï¼Œæ‰€æœ‰çµ„ä»¶Ã—Kï¼Œè§£ç´„é‡‘=ç¸®æ¸›å¾Œå‰©é¤˜ä¿å–®åƒ¹å€¼</p>';
  html += '</div>';
  html += '</div>';
  
  // èªªæ˜
  html += '<div class="glass rounded-xl p-4 mt-4 text-sm bg-orange-500/10">';
  html += '<p class="text-orange-300 font-semibold mb-2">ğŸ’¡ éƒ¨ä»½æé ˜è©¦ç®—èªªæ˜ (v7.19 ç­‰æ¯”ä¾‹åˆ‡å‰²æ³•)</p>';
  html += '<ul class="text-white/70 list-disc list-inside space-y-1">';
  html += '<li>æé ˜é‡‘é¡ä»¥<strong class="text-orange-300">è¬ TWD</strong>ç‚ºå–®ä½</li>';
  html += '<li><strong class="text-yellow-300">ç¸®æ¸›æ¯”ä¾‹ R</strong> = æé ˜ / å‰ä¸€å¹´æœ«è§£ç´„é‡‘</li>';
  html += '<li><strong class="text-green-300">ä¿ç•™æ¯”ä¾‹ K</strong> = 1 - Rï¼ˆç•¶å¹´æ‰€æœ‰çµ„ä»¶ Ã— Kï¼‰</li>';
  html += '<li><strong class="text-pink-300">ç´¯è¨ˆå› å­</strong>ï¼šæ¯å¹´ç´¯ä¹˜ Kï¼ˆæ­·å¹´ç´¯ç©æ•ˆæœï¼‰</li>';
  html += '<li><strong class="text-blue-300">è§£ç´„é‡‘</strong> = ç¸®æ¸›å¾Œå‰©é¤˜ä¿å–®åƒ¹å€¼ï¼ˆæé ˜æ˜¯å¹´åˆçµç®—çš„ï¼‰</li>';
  html += '</ul>';
  html += '</div>';
  
  return html;
}

loadProducts();
</script>
</body>
</html>
